<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Arabic Thermal Printer Test - Complete QZ Tray Integration</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #333;
        line-height: 1.6;
      }

      .container {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      h1 {
        color: #2c3e50;
        text-align: center;
        margin-bottom: 10px;
        font-size: 2.5em;
      }

      .subtitle {
        text-align: center;
        color: #7f8c8d;
        margin-bottom: 30px;
        font-size: 1.2em;
      }

      .status {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-weight: bold;
        text-align: center;
      }

      .status.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .status.warning {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }

      .btn {
        display: inline-block;
        padding: 12px 24px;
        margin: 8px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s ease;
        min-width: 200px;
      }

      .btn-primary {
        background: linear-gradient(45deg, #3498db, #2980b9);
        color: white;
      }

      .btn-primary:hover {
        background: linear-gradient(45deg, #2980b9, #3498db);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
      }

      .btn-success {
        background: linear-gradient(45deg, #27ae60, #2ecc71);
        color: white;
      }

      .btn-success:hover {
        background: linear-gradient(45deg, #2ecc71, #27ae60);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
      }

      .btn-warning {
        background: linear-gradient(45deg, #f39c12, #e67e22);
        color: white;
      }

      .btn-warning:hover {
        background: linear-gradient(45deg, #e67e22, #f39c12);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(243, 156, 18, 0.3);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin: 20px 0;
      }

      .card {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        border-left: 4px solid #3498db;
      }

      .card h3 {
        color: #2c3e50;
        margin-top: 0;
      }

      .arabic-text {
        direction: rtl;
        text-align: right;
        font-size: 18px;
        line-height: 1.8;
        background: #f1f2f6;
        padding: 15px;
        border-radius: 8px;
        border-right: 4px solid #00a8ff;
        margin: 10px 0;
      }

      .code-block {
        background: #2c3e50;
        color: #ecf0f1;
        padding: 20px;
        border-radius: 8px;
        font-family: "Courier New", monospace;
        font-size: 14px;
        overflow-x: auto;
        margin: 15px 0;
      }

      .highlight {
        background: #e74c3c;
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
      }

      .features {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin: 15px 0;
      }

      .feature {
        background: #27ae60;
        color: white;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
      }

      .logs {
        background: #2c3e50;
        color: #ecf0f1;
        padding: 15px;
        border-radius: 8px;
        font-family: "Courier New", monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
        margin: 15px 0;
      }

      .receipt-preview {
        background: #f8f9fa;
        border: 2px dashed #bdc3c7;
        border-radius: 8px;
        padding: 20px;
        font-family: "Courier New", monospace;
        font-size: 14px;
        line-height: 1.4;
        white-space: pre-line;
        direction: rtl;
        text-align: right;
        max-height: 500px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>🇸🇦 Arabic Thermal Printer Test</h1>
      <p class="subtitle">
        Complete QZ Tray Integration with IBM864 Encoding & RTL Support
      </p>

      <div id="status" class="status warning">
        Initializing QZ Tray connection...
      </div>

      <div class="grid">
        <div class="card">
          <h3>🖨️ QZ Tray Controls</h3>
          <button class="btn btn-primary" onclick="connectQZ()">
            Connect to QZ Tray
          </button>
          <button class="btn btn-primary" onclick="findPrinters()">
            Find Printers
          </button>
          <button class="btn btn-warning" onclick="checkQZStatus()">
            Check Status
          </button>
        </div>

        <div class="card">
          <h3>📄 Arabic Receipt Tests</h3>
          <button class="btn btn-success" onclick="printFullArabicReceipt()">
            Print Complete Arabic Receipt
          </button>
          <button class="btn btn-success" onclick="printSimpleArabicTest()">
            Print Simple Arabic Test
          </button>
          <button class="btn btn-success" onclick="previewArabicReceipt()">
            Preview Arabic Receipt
          </button>
        </div>
      </div>

      <div class="card">
        <h3>✨ Features Implemented</h3>
        <div class="features">
          <span class="feature">IBM864 Encoding</span>
          <span class="feature">RTL Text Direction</span>
          <span class="feature">Arabic Numerals</span>
          <span class="feature">QZ Tray Integration</span>
          <span class="feature">ESC/POS Commands</span>
          <span class="feature">Proper Alignment</span>
          <span class="feature">Mixed Content</span>
          <span class="feature">Receipt Structure</span>
        </div>
      </div>

      <div class="card">
        <h3>🔧 Technical Implementation</h3>
        <div class="code-block">
          // QZ Tray Configuration for Arabic Printing var config =
          qz.configs.create("Printer Name", { encoding: 'IBM864' // Critical for
          Arabic support }); // ESC/POS Commands for Arabic var data = [
          '\x1B\x40', // Initialize printer '\x1B\x74\x25', // Set IBM864
          codepage '\x1B\x52\x11', // Set Arabic character set '\x1B\x61\x02',
          // Right align for Arabic text 'مطعم الفول والفلافل', // Arabic text
          '\x0A', // Line feed '\x1B\x61\x00', // Left align for numbers '57.50
          ريال', // Price with Arabic currency '\x1B\x69' // Cut paper ];
          qz.print(config, data);
        </div>
      </div>

      <div class="card">
        <h3>📝 Sample Arabic Content</h3>
        <div class="arabic-text">
          مطعم الفول والفلافل<br />
          شارع الملك فهد، الرياض<br />
          الهاتف: ٠١١-٤٥٦-٧٨٩٠<br />
          الرقم الضريبي: ٣٠٠-٤٥٦-٧٨٩<br /><br />

          رقم الطلب: ١٢٣٤٥<br />
          الكاشير: أحمد محمد<br /><br />

          تفاصيل الطلب:<br />
          فول مدمس ٢ × ١٥.٥٠ = ٣١.٠٠ ريال<br />
          فلافل مع الطحينة ١ × ١٢.٠٠ = ١٢.٠٠ ريال<br /><br />

          المجموع الكلي: ٦٦.١٣ ريال<br />
          شكراً لزيارتكم
        </div>
      </div>

      <div class="card">
        <h3>�� Receipt Preview</h3>
        <div id="receiptPreview" class="receipt-preview">
          Click "Preview Arabic Receipt" to see the formatted receipt...
        </div>
      </div>

      <div class="card">
        <h3>📋 System Logs</h3>
        <div id="logs" class="logs">
          System initialized. Ready for Arabic printing tests...
        </div>
      </div>
    </div>

    <!-- QZ Tray Library -->
    <script src="https://cdn.jsdelivr.net/npm/qz-tray@2.2.4/qz-tray.min.js"></script>

    <script>
      let qzConnected = false;
      let selectedPrinter = null;

      // Logging function
      function log(message, type = "info") {
        const logs = document.getElementById("logs");
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
        logs.textContent += logEntry;
        logs.scrollTop = logs.scrollHeight;
        console.log(logEntry);
      }

      // Update status
      function updateStatus(message, type) {
        const status = document.getElementById("status");
        status.textContent = message;
        status.className = `status ${type}`;
      }

      // Connect to QZ Tray
      async function connectQZ() {
        try {
          log("Attempting to connect to QZ Tray...");
          await qz.websocket.connect();
          qzConnected = true;
          updateStatus("✅ Connected to QZ Tray successfully!", "success");
          log("QZ Tray connected successfully");

          // Auto-find printers after connection
          await findPrinters();
        } catch (error) {
          qzConnected = false;
          updateStatus(
            "❌ Failed to connect to QZ Tray. Make sure it's running.",
            "error"
          );
          log(`Connection failed: ${error.message}`, "error");
        }
      }

      // Find available printers
      async function findPrinters() {
        if (!qzConnected) {
          updateStatus("⚠️ Please connect to QZ Tray first", "warning");
          return;
        }

        try {
          log("Searching for available printers...");
          const printers = await qz.printers.find();

          if (printers.length > 0) {
            selectedPrinter = printers[0]; // Select first printer
            log(`Found ${printers.length} printer(s):`);
            printers.forEach((printer, index) => {
              log(`  ${index + 1}. ${printer}`);
            });
            log(`Selected printer: ${selectedPrinter}`);
            updateStatus(
              `🖨️ Found ${printers.length} printer(s). Selected: ${selectedPrinter}`,
              "success"
            );
          } else {
            updateStatus(
              "⚠️ No printers found. Please check printer connections.",
              "warning"
            );
            log("No printers found", "warning");
          }
        } catch (error) {
          updateStatus("❌ Error finding printers", "error");
          log(`Error finding printers: ${error.message}`, "error");
        }
      }

      // Check QZ Tray status
      async function checkQZStatus() {
        try {
          if (qz.websocket.isActive()) {
            const version = await qz.websocket.getVersion();
            updateStatus(
              `✅ QZ Tray ${version} is active and ready`,
              "success"
            );
            log(`QZ Tray version: ${version}`);
          } else {
            updateStatus("❌ QZ Tray is not active", "error");
            log("QZ Tray is not active", "error");
          }
        } catch (error) {
          updateStatus("❌ Error checking QZ Tray status", "error");
          log(`Status check failed: ${error.message}`, "error");
        }
      }

      // Print complete Arabic receipt
      async function printFullArabicReceipt() {
        if (!qzConnected || !selectedPrinter) {
          updateStatus(
            "⚠️ Please connect to QZ Tray and select a printer first",
            "warning"
          );
          return;
        }

        try {
          log("Generating complete Arabic receipt...");

          // Create QZ config with IBM864 encoding
          const config = qz.configs.create(selectedPrinter, {
            encoding: "IBM864",
            endOfDoc: "\n",
          });

          // Generate complete Arabic receipt data
          const receiptData = generateArabicReceiptCommands();

          const printData = [
            {
              type: "raw",
              format: "plain",
              data: receiptData,
            },
          ];

          log("Sending Arabic receipt to printer...");
          await qz.print(config, printData);

          updateStatus("✅ Arabic receipt printed successfully!", "success");
          log("Arabic receipt printed successfully with IBM864 encoding");
        } catch (error) {
          updateStatus("❌ Failed to print Arabic receipt", "error");
          log(`Print failed: ${error.message}`, "error");
        }
      }

      // Print simple Arabic test
      async function printSimpleArabicTest() {
        if (!qzConnected || !selectedPrinter) {
          updateStatus(
            "⚠️ Please connect to QZ Tray and select a printer first",
            "warning"
          );
          return;
        }

        try {
          log("Printing simple Arabic test...");

          const config = qz.configs.create(selectedPrinter, {
            encoding: "IBM864",
          });

          const testData = [
            "\x1B\x40", // Initialize
            "\x1B\x74\x25", // Set IBM864 codepage
            "\x1B\x52\x11", // Set Arabic character set
            "\x1B\x61\x01", // Center align
            "\x1B\x45\x01", // Bold on
            "اختبار الطباعة العربية\n", // Arabic Test Print
            "\x1B\x45\x00", // Bold off
            "\x1B\x61\x02", // Right align
            "مطعم الفول والفلافل\n", // Restaurant name
            "الرياض، المملكة العربية السعودية\n", // Riyadh, Saudi Arabia
            "\x1B\x61\x00", // Left align
            "Test completed successfully!\n",
            "\n\n\n",
            "\x1B\x69", // Cut paper
          ];

          const printData = [
            {
              type: "raw",
              format: "plain",
              data: testData.join(""),
            },
          ];

          await qz.print(config, printData);
          updateStatus("✅ Simple Arabic test printed!", "success");
          log("Simple Arabic test completed successfully");
        } catch (error) {
          updateStatus("❌ Simple Arabic test failed", "error");
          log(`Simple test failed: ${error.message}`, "error");
        }
      }

      // Preview Arabic receipt
      function previewArabicReceipt() {
        log("Generating Arabic receipt preview...");

        const receiptCommands = generateArabicReceiptCommands();
        const preview = convertCommandsToPreview(receiptCommands);

        document.getElementById("receiptPreview").textContent = preview;
        updateStatus("📄 Arabic receipt preview generated", "success");
        log("Receipt preview generated successfully");
      }

      // Generate Arabic receipt commands
      function generateArabicReceiptCommands() {
        const commands = [
          "\x1B\x40", // Initialize printer
          "\x1B\x74\x25", // Set IBM864 codepage
          "\x1B\x52\x11", // Set Arabic character set

          // Header
          "\x1B\x61\x01", // Center align
          "\x1B\x45\x01", // Bold on
          "\x1B\x21\x10", // Double height
          "مطعم الفول والفلافل\n", // Restaurant name
          "\x1B\x21\x00", // Normal size
          "\x1B\x45\x00", // Bold off

          "شارع الملك فهد، الرياض\n", // Address
          "الهاتف: ٠١١-٤٥٦-٧٨٩٠\n", // Phone
          "الرقم الضريبي: ٣٠٠-٤٥٦-٧٨٩\n", // Tax number
          "\x1B\x61\x00", // Left align
          "\n",

          // Date and order info
          "\x1B\x61\x02", // Right align
          "٢٠٢٤/١٢/٢٥ ١٤:٣٠\n", // Date and time
          "\x1B\x61\x00", // Left align
          "رقم الطلب: ١٢٣٤٥\n", // Order number
          "الكاشير: أحمد محمد\n", // Cashier
          "\n",

          // Customer info
          "بيانات العميل:\n", // Customer data
          "--------------------------------\n",
          "الاسم: سارة أحمد\n", // Name
          "الهاتف: ٠٥٠-١٢٣-٤٥٦٧\n", // Phone
          "\n",

          // Items
          "================================\n",
          "تفاصيل الطلب:\n", // Order details
          "================================\n",

          "\x1B\x61\x02", // Right align for Arabic
          "فول مدمس\n", // Item 1
          "\x1B\x61\x00", // Left align for numbers
          "2 × 15.50 = 31.00 ريال\n",
          "\n",

          "\x1B\x61\x02", // Right align
          "فلافل مع الطحينة\n", // Item 2
          "\x1B\x61\x00", // Left align
          "1 × 12.00 = 12.00 ريال\n",
          "\n",

          "\x1B\x61\x02", // Right align
          "حمص بالطحينة\n", // Item 3
          "\x1B\x61\x00", // Left align
          "1 × 8.50 = 8.50 ريال\n",
          "\n",

          "\x1B\x61\x02", // Right align
          "خبز عربي\n", // Item 4
          "\x1B\x61\x00", // Left align
          "3 × 2.00 = 6.00 ريال\n",

          "--------------------------------\n",

          // Totals
          "\x1B\x61\x02", // Right align
          "المجموع الفرعي:\n", // Subtotal
          "\x1B\x61\x00", // Left align
          "57.50 ريال\n",

          "\x1B\x61\x02", // Right align
          "الضريبة (١٥٪):\n", // Tax
          "\x1B\x61\x00", // Left align
          "8.63 ريال\n",

          "================================\n",

          "\x1B\x45\x01", // Bold on
          "\x1B\x21\x10", // Double height
          "\x1B\x61\x02", // Right align
          "المجموع الكلي:\n", // Total
          "\x1B\x61\x00", // Left align
          "66.13 ريال\n",
          "\x1B\x21\x00", // Normal size
          "\x1B\x45\x00", // Bold off

          "================================\n",

          // Payment
          "\x1B\x61\x02", // Right align
          "طريقة الدفع: نقداً\n", // Payment method
          "المبلغ المدفوع: 70.00 ريال\n", // Amount paid
          "الباقي: 3.87 ريال\n", // Change
          "\n",

          // Footer
          "\x1B\x61\x01", // Center align
          "\x1B\x45\x01", // Bold on
          "شكراً لزيارتكم\n", // Thank you
          "\x1B\x45\x00", // Bold off
          "يرجى الاحتفاظ بالإيصال\n", // Keep receipt
          "\n",
          "www.foul-flafel.com\n",

          "\x1B\x61\x00", // Left align
          "\x1B\x52\x00", // Reset charset
          "\n\n\n",
          "\x1B\x69", // Cut paper
        ];

        return commands.join("");
      }

      // Convert ESC/POS commands to readable preview
      function convertCommandsToPreview(commands) {
        let preview = commands;

        // Remove ESC/POS commands for preview
        preview = preview.replace(/\x1B[\x40\x45\x21\x61\x74\x52\x69]/g, "");
        preview = preview.replace(/\x1B[\x40-\xFF]./g, "");

        // Clean up extra control characters
        preview = preview.replace(/[\x00-\x1F]/g, function (match) {
          return match === "\n" ? "\n" : "";
        });

        return preview;
      }

      // Initialize on page load
      window.onload = function () {
        log("Arabic Thermal Printer Test initialized");
        log("Make sure QZ Tray is running before connecting");

        // Auto-connect if QZ is available
        if (typeof qz !== "undefined") {
          setTimeout(connectQZ, 1000);
        } else {
          updateStatus("❌ QZ Tray library not loaded", "error");
          log("QZ Tray library not available", "error");
        }
      };
    </script>
  </body>
</html>
