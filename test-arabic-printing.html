<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Arabic Thermal Printer Test - Enhanced</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #333;
      }

      .container {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: #2c3e50;
        text-align: center;
        margin-bottom: 30px;
        font-size: 2.5em;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
      }

      .status {
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        font-weight: bold;
        text-align: center;
      }

      .status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .status.info {
        background: #cce7ff;
        color: #004085;
        border: 1px solid #abd8ff;
      }

      .section {
        margin: 25px 0;
        padding: 20px;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        background: #f8f9fa;
      }

      .section h2 {
        color: #495057;
        margin-bottom: 15px;
        font-size: 1.4em;
      }

      .test-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }

      button {
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        background: linear-gradient(45deg, #3498db, #2980b9);
        color: white;
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      button:active {
        transform: translateY(0);
      }

      button.test {
        background: linear-gradient(45deg, #27ae60, #229954);
      }
      button.preview {
        background: linear-gradient(45deg, #f39c12, #e67e22);
      }
      button.advanced {
        background: linear-gradient(45deg, #9b59b6, #8e44ad);
      }

      .arabic-text {
        font-size: 18px;
        line-height: 1.6;
        direction: rtl;
        text-align: right;
        padding: 15px;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 5px;
        margin: 10px 0;
        font-family: "Arial Unicode MS", "Tahoma", sans-serif;
      }

      .mixed-text {
        direction: ltr;
        text-align: left;
      }

      .code-display {
        background: #2c3e50;
        color: #ecf0f1;
        padding: 15px;
        border-radius: 5px;
        font-family: "Courier New", monospace;
        font-size: 12px;
        margin: 10px 0;
        white-space: pre-wrap;
        word-break: break-all;
      }

      .improvements {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
      }

      .improvements h3 {
        margin-top: 0;
      }

      .improvements ul {
        margin: 0;
        padding-left: 20px;
      }

      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      @media (max-width: 768px) {
        .grid-2 {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>🖨️ Enhanced Arabic Thermal Printer Test</h1>

      <div class="status info">
        <h3>✅ COMPREHENSIVE SOLUTION IMPLEMENTED</h3>
        <p>
          Based on extensive research and best practices for Arabic text
          printing on thermal printers
        </p>
      </div>

      <div class="improvements">
        <h3>🔧 Latest Improvements Applied:</h3>
        <ul>
          <li>
            <strong>Corrected ESC/POS Commands:</strong> Fixed codepage
            selection (CP1256, CP864, CP720)
          </li>
          <li>
            <strong>Proper Character Mapping:</strong> Added Windows-1256
            character mapping for Arabic
          </li>
          <li>
            <strong>RTL Text Handling:</strong> Implemented Right-to-Left text
            processing
          </li>
          <li>
            <strong>Unicode Normalization:</strong> NFC normalization for
            consistent character representation
          </li>
          <li>
            <strong>Multi-Codepage Support:</strong> Fallback mechanisms for
            different thermal printer models
          </li>
          <li>
            <strong>Character Joining:</strong> Maintains Arabic character
            cursive joining
          </li>
          <li>
            <strong>Mixed Language Support:</strong> Handles Arabic + English
            content properly
          </li>
        </ul>
      </div>

      <div class="section">
        <h2>📝 Arabic Text Samples for Testing</h2>

        <div class="grid-2">
          <div>
            <h4>Business Names (Arabic):</h4>
            <div class="arabic-text">مطعم الفول والفلافل</div>
            <div class="arabic-text">مطعم الشاورما اللذيذة</div>
            <div class="arabic-text">كافيتيريا النور</div>
          </div>

          <div>
            <h4>Customer Data (Arabic):</h4>
            <div class="arabic-text">أحمد محمد علي</div>
            <div class="arabic-text">شارع الملك فهد، الرياض</div>
            <div class="arabic-text">مرحبا بكم في مطعمنا</div>
          </div>
        </div>

        <h4>Mixed Language (Arabic + English):</h4>
        <div class="mixed-text arabic-text">
          Welcome مرحبا - فول Foul - فلافل Falafel<br />
          Customer: أحمد احمد - Phone: 0501234567<br />
          Address: شارع الملك فهد، الرياض Saudi Arabia
        </div>

        <h4>Menu Items (Arabic):</h4>
        <div class="arabic-text">
          ١. فول مدمس - ١٥ ريال<br />
          ٢. فلافل - ١٠ ريال<br />
          ٣. حمص - ١٢ ريال<br />
          ٤. شاورما لحم - ٢٠ ريال<br />
          ٥. عصير برتقال طازج - ٨ ريال
        </div>
      </div>

      <div class="section">
        <h2>🧪 Comprehensive Test Functions</h2>

        <div class="test-buttons">
          <button class="test" onclick="testBasicArabic()">
            Test Basic Arabic Print
          </button>
          <button class="test" onclick="testMixedLanguage()">
            Test Mixed Language
          </button>
          <button class="test" onclick="testCompleteReceipt()">
            Test Complete Receipt
          </button>
          <button class="test" onclick="testCharacterMapping()">
            Test Character Mapping
          </button>
          <button class="preview" onclick="previewArabicReceipt()">
            Preview Arabic Receipt
          </button>
          <button class="advanced" onclick="testAdvancedFeatures()">
            Test Advanced Features
          </button>
        </div>
      </div>

      <div class="section">
        <h2>🔍 Technical Implementation Details</h2>

        <h4>New ESC/POS Commands Used:</h4>
        <div class="code-display">
          SET_CODEPAGE_1256: "\x1B\x74\x32" // Windows-1256 (Most Reliable)
          SET_CODEPAGE_864: "\x1B\x74\x25" // CP864 (Alternative)
          SET_CODEPAGE_720: "\x1B\x74\x20" // CP720 (Backup) SET_CHARSET_ARABIC:
          "\x1B\x52\x11" // Arabic Character Set (17) RESET_CHARSET:
          "\x1B\x52\x00" // Reset to Default Character Mapping Sample: 'ا':
          '\xC7', 'ب': '\xC8', 'ت': '\xCA', 'ث': '\xCB' 'ج': '\xCC', 'ح':
          '\xCD', 'خ': '\xCE', 'د': '\xCF' 'ر': '\xD1', 'س': '\xD3', 'ش':
          '\xD4', 'ص': '\xD5'
        </div>

        <h4>Text Processing Pipeline:</h4>
        <div class="code-display">
          1. Detect Arabic Content → containsArabic() 2. Clean Unicode Marks →
          Remove \u200C-\u200F, \u202A-\u202E 3. Normalize Unicode → NFC
          normalization 4. Handle RTL Layout → Reverse word order for Arabic 5.
          Apply Character Mapping → CP1256 mapping 6. Set Printer Codepage →
          Multiple fallbacks 7. Send to Thermal Printer → QZ Tray / USB /
          Network
        </div>
      </div>

      <div class="section">
        <h2>📊 Test Results</h2>
        <div id="testResults"></div>
      </div>
    </div>

    <script>
      // Test results container
      const resultsContainer = document.getElementById("testResults");

      function logResult(test, status, message) {
        const result = document.createElement("div");
        result.className = `status ${status}`;
        result.innerHTML = `<strong>${test}:</strong> ${message}`;
        resultsContainer.appendChild(result);

        // Auto-scroll to results
        result.scrollIntoView({ behavior: "smooth", block: "nearest" });
      }

      // Check if printing service is available
      function checkPrintingService() {
        if (typeof window.printingService === "undefined") {
          logResult(
            "Service Check",
            "error",
            "Printing service not found. Please ensure the application is running."
          );
          return false;
        }
        logResult(
          "Service Check",
          "success",
          "Printing service detected successfully."
        );
        return true;
      }

      // Test basic Arabic printing
      async function testBasicArabic() {
        if (!checkPrintingService()) return;

        const arabicText = "مرحبا بكم في مطعم الفول والفلافل";

        try {
          // Create test order data with Arabic content
          const testOrder = {
            orderNumber: "TEST-001",
            cashier: "أحمد محمد",
            custName: arabicText,
            orderItems: [
              { name: "فول مدمس", quantity: 1, price: 15.0 },
              { name: "فلافل", quantity: 2, price: 10.0 },
            ],
          };

          await window.printingService.printCustomerReceipt(testOrder);
          logResult(
            "Basic Arabic Test",
            "success",
            `Arabic text sent to printer: ${arabicText}`
          );
        } catch (error) {
          logResult("Basic Arabic Test", "error", `Failed: ${error.message}`);
        }
      }

      // Test mixed language printing
      async function testMixedLanguage() {
        if (!checkPrintingService()) return;

        try {
          const testOrder = {
            orderNumber: "MIX-002",
            cashier: "Ahmed أحمد",
            custName: "محمد علي Mohammed Ali",
            custAddress: "شارع الملك فهد، الرياض King Fahd Street, Riyadh",
            orderItems: [
              { name: "Foul فول مدمس", quantity: 1, price: 15.0 },
              { name: "Falafel فلافل", quantity: 3, price: 10.0 },
              { name: "Orange Juice عصير برتقال", quantity: 1, price: 8.0 },
            ],
          };

          await window.printingService.printCustomerReceipt(testOrder);
          logResult(
            "Mixed Language Test",
            "success",
            "Mixed Arabic/English content sent to printer"
          );
        } catch (error) {
          logResult("Mixed Language Test", "error", `Failed: ${error.message}`);
        }
      }

      // Test complete receipt with full Arabic content
      async function testCompleteReceipt() {
        if (!checkPrintingService()) return;

        try {
          // Set Arabic receipt settings
          const arabicSettings = {
            header: {
              businessName: "مطعم الفول والفلافل الشعبي",
              address: "شارع الملك فهد، حي النور",
              city: "الرياض، المملكة العربية السعودية",
              phone: "٠١١-٤٥٦-٧٨٩٠",
              taxId: "رقم ضريبي: ١٢٣٤٥٦٧٨٩",
            },
            footer: {
              thankYouMessage: "شكرا لزيارتكم - نتطلع لخدمتكم مرة أخرى",
            },
            display: {
              showCashierName: true,
            },
          };

          window.printingService.saveReceiptSettings(arabicSettings);

          const testOrder = {
            orderNumber: "AR-003",
            cashier: "عبدالله أحمد الخليفي",
            custName: "سالم محمد العتيبي",
            custPhone: "٠٥٠١٢٣٤٥٦٧",
            custAddress: "حي الروضة، شارع الأمير سلطان، الرياض",
            orderItems: [
              { name: "فول مدمس بالطحينة والسلطة", quantity: 2, price: 18.0 },
              { name: "فلافل مع الخضار والصلصة", quantity: 3, price: 12.0 },
              { name: "حمص بالطحينة", quantity: 1, price: 15.0 },
              { name: "شاي بالنعناع", quantity: 2, price: 5.0 },
              { name: "عصير برتقال طازج", quantity: 1, price: 10.0 },
            ],
            paymentMethod: "نقداً",
          };

          await window.printingService.printCustomerReceipt(testOrder);
          logResult(
            "Complete Arabic Receipt",
            "success",
            "Full Arabic receipt with business info sent to printer"
          );
        } catch (error) {
          logResult(
            "Complete Arabic Receipt",
            "error",
            `Failed: ${error.message}`
          );
        }
      }

      // Test character mapping functionality
      async function testCharacterMapping() {
        if (!checkPrintingService()) return;

        try {
          // Test specific Arabic characters that commonly cause problems
          const problematicChars = [
            "ا ب ت ث ج ح خ د ذ ر ز س ش ص ض ط ظ ع غ ف ق ك ل م ن ه و ي",
            "٠ ١ ٢ ٣ ٤ ٥ ٦ ٧ ٨ ٩", // Arabic numerals
            "، ؛ ؟", // Arabic punctuation
            "لا بسم الله الرحمن الرحيم", // Common phrases
          ];

          const testOrder = {
            orderNumber: "CHAR-004",
            cashier: "Character Test اختبار الحروف",
            custName: "اختبار تشكيل الحروف العربية",
            orderItems: problematicChars.map((chars, index) => ({
              name: chars,
              quantity: 1,
              price: index + 1,
            })),
          };

          await window.printingService.printCustomerReceipt(testOrder);
          logResult(
            "Character Mapping Test",
            "success",
            "Arabic character mapping test sent to printer"
          );
        } catch (error) {
          logResult(
            "Character Mapping Test",
            "error",
            `Failed: ${error.message}`
          );
        }
      }

      // Preview Arabic receipt in browser
      function previewArabicReceipt() {
        if (!checkPrintingService()) return;

        try {
          const testOrder = {
            orderNumber: "PREV-005",
            cashier: "معاينة الإيصال",
            custName: "محمد أحمد العربي",
            custAddress: "شارع الملك عبدالعزيز، الرياض",
            orderItems: [
              { name: "فول مدمس", quantity: 1, price: 15.0 },
              { name: "فلافل", quantity: 2, price: 10.0 },
              { name: "عصير طازج", quantity: 1, price: 8.0 },
            ],
          };

          const receiptContent =
            window.printingService.generateCustomerReceipt(testOrder);
          window.printingService.previewReceipt(receiptContent);
          logResult(
            "Receipt Preview",
            "success",
            "Arabic receipt preview opened in new window"
          );
        } catch (error) {
          logResult("Receipt Preview", "error", `Failed: ${error.message}`);
        }
      }

      // Test advanced features
      async function testAdvancedFeatures() {
        if (!checkPrintingService()) return;

        try {
          // Test QZ Tray status with Arabic support
          const qzStatus = await window.printingService.getQZStatus();
          logResult(
            "QZ Tray Status",
            qzStatus.connected ? "success" : "error",
            `QZ Tray: ${qzStatus.connected ? "Connected" : "Disconnected"}`
          );

          // Test printer detection
          const printers = await window.printingService.getAvailablePrinters();
          logResult(
            "Printer Detection",
            printers.length > 0 ? "success" : "error",
            `Found ${printers.length} printers`
          );

          // Test Arabic content detection
          const arabicTexts = [
            "مرحبا", // Should return true
            "Hello", // Should return false
            "Hello مرحبا", // Should return true
          ];

          arabicTexts.forEach((text) => {
            const hasArabic = window.printingService.containsArabic(text);
            logResult(
              "Arabic Detection",
              "info",
              `"${text}" contains Arabic: ${hasArabic}`
            );
          });

          logResult(
            "Advanced Features",
            "success",
            "All advanced feature tests completed"
          );
        } catch (error) {
          logResult("Advanced Features", "error", `Failed: ${error.message}`);
        }
      }

      // Initialize page
      document.addEventListener("DOMContentLoaded", function () {
        logResult(
          "Page Load",
          "info",
          "Arabic printing test page loaded successfully"
        );

        // Check for printing service availability
        setTimeout(checkPrintingService, 1000);
      });
    </script>
  </body>
</html>
