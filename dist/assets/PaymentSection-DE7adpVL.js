const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/PrintReceiptModal-DIEvAved.js","assets/index-HCY72ToG.js","assets/index-3IXj75bd.css"])))=>i.map(i=>d[i]);
import{j as e,u as C,a as G,J as H,b as A,r as f,V as g,K as O,L as P,y as Q,_ as X}from"./index-HCY72ToG.js";const I=({label:n,value:m,onChange:o,placeholder:p="0",min:x="0",max:y,step:t="0.01",className:u=""})=>{const j=v=>{v.target.select()},s=v=>{const l=v.target.value;if(l==="")o("");else{const N=t==="1"?parseInt(l):parseFloat(l);o(isNaN(N)?"":N)}};return e.jsxs("div",{className:u,children:[n&&e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:n}),e.jsx("input",{type:"number",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent",value:m??"",onChange:s,onFocus:j,placeholder:p,min:x,max:y,step:t})]})};function $({value:n,onChange:m}){const{t:o}=C();return e.jsxs("select",{value:n,onChange:m,className:"w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500",children:[e.jsx("option",{value:"cash",children:o("cashier.cash")}),e.jsx("option",{value:"visa",children:o("payment.visa")})]})}const Y=({subtotal:n,discount:m,discountAmount:o,tax:p,taxAmount:x,finalTotal:y})=>{const{t}=C();return e.jsxs("div",{className:"bg-gray-50 rounded-lg p-2 sm:p-4 space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-gray-600",children:[t("cashier.subtotal"),":"]}),e.jsxs("span",{className:"font-medium",children:[n.toFixed(2)," AED"]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-gray-600",children:[t("cashier.discount")," (",m||0,"%):"]}),e.jsxs("span",{className:"font-medium text-red-600",children:["-",o.toFixed(2)," AED"]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-gray-600",children:[t("cashier.tax")," (",p||0,"%):"]}),e.jsxs("span",{className:"font-medium",children:["+",x.toFixed(2)," AED"]})]}),e.jsx("div",{className:"border-t border-gray-300 pt-2",children:e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsxs("span",{children:[t("cashier.total"),":"]}),e.jsxs("span",{className:"text-primary-700",children:[y.toFixed(2)," AED"]})]})})]})};function Z({paymentMode:n,setPaymentMode:m}){const{t:o}=C();return e.jsxs("div",{className:"flex bg-gray-100 rounded-lg p-1 mb-4",children:[e.jsx("button",{type:"button",onClick:()=>m("single"),className:`flex-1 py-2 px-4 text-sm font-medium rounded-md transition-colors ${n==="single"?"bg-white text-gray-900 shadow-sm":"text-gray-600 hover:text-gray-900"}`,children:o("payment.singlePayment")}),e.jsx("button",{type:"button",onClick:()=>m("split"),className:`flex-1 py-2 px-4 text-sm font-medium rounded-md transition-colors ${n==="split"?"bg-white text-gray-900 shadow-sm":"text-gray-600 hover:text-gray-900"}`,children:o("payment.splitPayment")})]})}const ee=({payment:n,index:m,onMethodChange:o,onAmountChange:p,finalTotal:x})=>{const y=t=>{p(m,t);const u=m===0?1:0;if(p(u,""),t&&!isNaN(t)){const j=x-parseFloat(t);j>0?p(u,parseFloat(j.toFixed(2))):p(u,0)}};return e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"flex-1",children:e.jsx($,{value:n.method,onChange:t=>o(m,t.target.value)})}),e.jsx("div",{className:"flex-1",children:e.jsx(I,{value:n.amount,onChange:y,placeholder:"0.00",min:"0",step:"1"})})]})},te=f.lazy(()=>X(()=>import("./PrintReceiptModal-DIEvAved.js"),__vite__mapDeps([0,1,2])));function ae({tax:n,setTax:m,discount:o,setDiscount:p,subtotal:x,discountAmount:y}){const{t}=C(),u=G(),j=H(),{currentOrder:s}=A(a=>a.order),{loading:v}=A(a=>a.payment),{currentShift:l}=A(a=>a.shift),{user:N}=A(a=>a.auth),[F,T]=f.useState("single"),[M,L]=f.useState("cash"),[_,k]=f.useState([{method:"cash",amount:""},{method:"visa",amount:""}]),[z,D]=f.useState(!1),E=x*(n||0)/100,h=x-y+E,J=f.useCallback((a,c)=>{k(r=>{const d=[...r];return d[a].method=c,d})},[]),K=f.useCallback((a,c)=>{k(r=>{const d=[...r];return d[a].amount=c,d})},[]),U=_.reduce((a,c)=>{const r=parseFloat(c.amount)||0;return a+r},0),R=h-U,W=()=>{const a=_.filter(r=>(parseFloat(r.amount)||0)>0);if(a.length===0)return{isValid:!1,message:t("payment.enterPaymentAmount")};const c=a.reduce((r,d)=>r+parseFloat(d.amount),0);if(c<h)return{isValid:!1,message:`${t("payment.needMoreAmount")} ${(h-c).toFixed(2)} AED`};if(c>h){const r=[...a];let d=h;for(let i=0;i<r.length;i++){const b=parseFloat(r[i].amount);if(d>=b)d-=b;else{r[i].amount=d,d=0,r.splice(i+1);break}}return{isValid:!0,payments:r}}return{isValid:!0,payments:a}},q=async()=>{var a,c,r,d;if(!s){g.error(t("payment.noOrderSelected"));return}if(s.isPaid){g.error(t("payment.orderAlreadyPaid"));return}try{let i=[];if(F==="single")i=[{method:M,amount:h}];else{const w=W();if(!w.isValid){g.error(w.message);return}i=w.payments.map(V=>({method:V.method,amount:parseFloat(V.amount)}))}if((await u(O({orderId:s._id,paymentMethods:i,tax:n||0,discount:o||0})).unwrap()).alreadyPaid){g.success(t("payment.alreadyPaidSuccess"),{duration:3e3,icon:"✅"}),l!=null&&l._id?await u(P({shiftId:l._id})):await u(P()),setTimeout(()=>{j("/menu")},1500);return}l!=null&&l._id?await u(P({shiftId:l._id})):await u(P()),g.success(t("payment.paymentSuccess"),{duration:3e3,icon:"✅"}),setTimeout(()=>{j("/menu")},1500);const S={...s,orderNumber:s.orderCode||((a=s._id)==null?void 0:a.slice(-8))||"N/A",cashier:(N==null?void 0:N.name)||"System",paymentMethods:i,tax:n||0,discount:o||0,finalTotal:h,orderItems:s.orderItems||[],orderItemsData:s.orderItemsData||[],custName:s.custName||"",custPhone:s.custPhone||s.custtPhone||"",custAddress:s.custAddress||""};try{await Q.printCustomerReceipt(S)}catch(w){console.warn("Customer receipt print failed:",w)}}catch(i){console.error("Payment failed:",i);let b=t("payment.paymentFailedRetry"),S=!1;if(i.shouldRetry?(b=i.message+" Would you like to try again?",S=!0):i.message&&(b=i.message),(c=i.message)!=null&&c.includes("already paid")||(d=(r=i.originalError)==null?void 0:r.message)!=null&&d.includes("already paid")){l!=null&&l._id?await u(P({shiftId:l._id})):await u(P()),g.error(t("payment.paymentStatusUnclear"),{duration:5e3,icon:"⚠️"});return}g.error(b,{duration:S?6e3:4e3,icon:"❌"})}},B=()=>{if(!s){g.error(t("payment.noOrderSelected"));return}D(!0)};return e.jsxs("div",{className:"bg-white rounded-lg shadow-card p-2 sm:p-6 space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(I,{label:t("payment.taxPercent"),value:n,onChange:m,placeholder:"0",min:"0",max:"100",step:"1"}),e.jsx(I,{label:t("payment.discountPercent"),value:o,onChange:p,placeholder:"0",min:"0",max:"100",step:"1"})]}),e.jsx(Y,{subtotal:x,discount:o,discountAmount:y,tax:n,taxAmount:E,finalTotal:h}),e.jsxs("div",{children:[e.jsx("label",{className:"hidden sm:block text-sm font-medium text-gray-700 mb-3",children:t("payment.paymentMethod")}),e.jsx(Z,{paymentMode:F,setPaymentMode:T}),F==="single"&&e.jsx($,{value:M,onChange:a=>L(a.target.value)}),F==="split"&&e.jsxs("div",{className:"space-y-3",children:[_.map((a,c)=>e.jsx(ee,{payment:a,index:c,onMethodChange:J,onAmountChange:K,finalTotal:h},c)),e.jsxs("div",{className:"text-sm text-gray-600 bg-blue-50 p-2 rounded text-start",children:[t("payment.remaining"),":"," ",e.jsx("span",{className:`font-medium ${R>0?"text-red-600":"text-green-600"}`,children:R.toFixed(2)})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{onClick:q,disabled:v||!s||(s==null?void 0:s.isPaid),className:`w-full py-3 px-4 rounded-md transition-colors font-medium ${s!=null&&s.isPaid?"bg-green-100 text-green-800 cursor-not-allowed":"bg-green-600 text-white hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed"}`,children:s!=null&&s.isPaid?t("payment.orderAlreadyPaid"):v?t("payment.processing"):`${t("payment.pay")} ${h.toFixed(2)} AED`}),e.jsx("button",{onClick:B,className:"w-full py-2 px-4 bg-primary-700 text-white rounded-md hover:bg-primary-800 transition-colors",children:s!=null&&s.isPaid?t("payment.printReceipt"):t("payment.printPreview")})]}),z&&e.jsx(f.Suspense,{fallback:e.jsx("div",{children:t("common.loading")}),children:e.jsx(te,{order:s,onClose:()=>D(!1)})})]})}export{ae as default};
