import{u as R,a as z,b as v,r as l,T,U as O,h as B,V as f,W as V,X as W,Y as X,j as e,M as Y,R as Z,F as G,k as H,Z as J}from"./index-Z9s42iMQ.js";const Q=({meal:i,preSelectedCategoryId:U,onClose:h})=>{var M;const{t:o,i18n:A}=R(),N=A.language==="ar",m=!!i,u=z(),{createLoading:k,updateLoading:F,error:C}=v(s=>s.meals),{categories:S}=v(s=>s.categories),{stocks:p}=v(s=>s.stock),$=s=>!s||s.length===0?[{stockItemId:"",quantityUsed:1,unit:"pcs",stockName:""}]:s.map(r=>({stockItemId:J(r.stockItemId)||"",quantityUsed:r.quantityUsed||1,unit:r.unit||"pcs",stockName:r.stockName||typeof r.stockItemId=="object"&&(r.stockItemId.nameOfItem||r.stockItemId.name)||""})),[a,g]=l.useState({name:(i==null?void 0:i.name)||"",categoryId:T(i==null?void 0:i.categoryId)||U||"",price:(i==null?void 0:i.price)||"",isAvailable:(i==null?void 0:i.isAvailable)!==void 0?i==null?void 0:i.isAvailable:!0,image:null,ingredients:$(i==null?void 0:i.ingredients)}),[q,D]=l.useState(((M=i==null?void 0:i.image)==null?void 0:M.url)||null),[c,y]=l.useState({});l.useEffect(()=>{u(O()),u(B())},[u]);const I=l.useMemo(()=>k||F,[k,F]),w=l.useCallback(()=>{const s={};return a.name.trim()||(s.name="Meal name is required"),a.categoryId||(s.categoryId="Category is required"),(!a.price||a.price<=0)&&(s.price="Price must be greater than 0"),!m&&!a.image&&(s.image="Image is required for new meals"),a.ingredients.filter(t=>t.stockItemId&&t.quantityUsed>0).length===0&&(s.ingredients="At least one ingredient is required"),y(s),Object.keys(s).length===0},[a,m]),b=l.useCallback(s=>{const{name:r,value:t,type:n,checked:d}=s.target;g(x=>({...x,[r]:n==="checkbox"?d:n==="number"?t===""?"":Number(t):t})),c[r]&&y(x=>({...x,[r]:null}))},[c]),E=l.useCallback(s=>{const r=s.target.files[0];if(r){if(r.size>2*1024*1024){f.error("Image size must be less than 2MB");return}if(!r.type.startsWith("image/")){f.error("Please select a valid image file");return}const t=new FileReader;t.onloadend=()=>{D(t.result),g(n=>({...n,image:r}))},t.readAsDataURL(r),c.image&&y(n=>({...n,image:null}))}},[c.image]),j=l.useCallback((s,r,t)=>{const n=[...a.ingredients];if(n[s]={...n[s],[r]:r==="quantityUsed"?Number(t)||0:t},r==="stockItemId"){const d=p==null?void 0:p.find(x=>x._id===t);d&&(n[s].stockName=d.nameOfItem||d.name||"")}g(d=>({...d,ingredients:n})),c.ingredients&&y(d=>({...d,ingredients:null}))},[a.ingredients,c.ingredients,p]),_=l.useCallback(()=>{g(s=>({...s,ingredients:[...s.ingredients,{stockItemId:"",quantityUsed:1,unit:"pcs",stockName:""}]}))},[]),L=l.useCallback(s=>{if(a.ingredients.length>1){const r=a.ingredients.filter((t,n)=>n!==s);g(t=>({...t,ingredients:r}))}},[a.ingredients.length]),P=l.useCallback(async s=>{if(s.preventDefault(),!!w())try{const r=new FormData;r.append("name",a.name),r.append("categoryId",a.categoryId),r.append("price",a.price),r.append("isAvailable",a.isAvailable),a.image&&r.append("image",a.image),a.ingredients.filter(n=>n.stockItemId&&n.quantityUsed>0).forEach((n,d)=>{r.append(`ingredients[${d}][stockItemId]`,n.stockItemId),r.append(`ingredients[${d}][quantityUsed]`,n.quantityUsed),r.append(`ingredients[${d}][unit]`,n.unit),r.append(`ingredients[${d}][stockName]`,n.stockName||"")}),m?(await u(V({mealId:i._id,mealData:r})).unwrap(),f.success("Meal updated successfully!")):(await u(W(r)).unwrap(),f.success("Meal created successfully!")),u(X()),h()}catch(r){f.error(r.message||`Failed to ${m?"update":"create"} meal`)}},[w,a,m,i,u,h]);return e.jsx(Y,{title:o(m?"forms.mealForm.editMeal":"forms.mealForm.addMeal"),onClose:h,size:"lg",children:e.jsxs("div",{className:"space-y-6",dir:N?"rtl":"ltr",children:[C&&e.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-md text-sm",children:C}),e.jsxs("form",{onSubmit:P,className:"space-y-4",children:[e.jsx("div",{className:"flex justify-center mb-6",children:e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-32 h-32 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center cursor-pointer hover:border-primary-500 transition-colors group",onClick:()=>document.getElementById("imageInput").click(),children:q?e.jsx("img",{src:q,alt:o("forms.mealForm.mealImage"),className:"w-full h-full object-cover rounded-lg"}):e.jsxs("div",{className:"text-center",children:[e.jsx(Z,{className:"mx-auto text-gray-400 text-2xl mb-2 group-hover:text-primary-500 transition-colors"}),e.jsx("p",{className:"text-sm text-gray-500 group-hover:text-primary-500 transition-colors",children:o("forms.mealForm.uploadImage")})]})}),e.jsx("input",{id:"imageInput",type:"file",accept:"image/*",onChange:E,className:"hidden"})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[o("forms.mealForm.mealName")," *"]}),e.jsx("input",{type:"text",name:"name",value:a.name,onChange:b,className:`px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary-800/50 focus:border-primary-800 w-full ${c.name?"border-red-500":"border-gray-300"}`,placeholder:o("forms.mealForm.enterMealName"),required:!0}),c.name&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:c.name})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[o("forms.mealForm.price")," *"]}),e.jsx("input",{type:"number",name:"price",value:a.price,onChange:b,className:`px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary-800/50 focus:border-primary-800 w-full ${c.price?"border-red-500":"border-gray-300"}`,placeholder:o("forms.mealForm.enterPrice"),min:"0",step:"0.01",required:!0}),c.price&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:c.price})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[o("forms.mealForm.category")," *"]}),e.jsxs("select",{name:"categoryId",value:a.categoryId,onChange:b,className:`px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary-800/50 focus:border-primary-800 w-full ${c.categoryId?"border-red-500":"border-gray-300"}`,required:!0,children:[e.jsx("option",{value:"",children:o("forms.mealForm.selectCategory")}),S.map(s=>e.jsx("option",{value:s._id,children:s.name},s._id))]}),c.categoryId&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:c.categoryId})]}),e.jsx("div",{children:e.jsxs("div",{className:"flex items-center mt-2 gap-1",children:[e.jsx("input",{type:"checkbox",name:"isAvailable",checked:a.isAvailable,onChange:b,className:"h-4 w-4 text-primary rounded focus:ring-primary-800 "}),e.jsx("span",{className:"ml-2 text-gray-700",children:o("forms.mealForm.mealAvailable")})]})}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[o("forms.mealForm.ingredients")," *"]}),c.ingredients&&e.jsx("p",{className:"text-red-500 text-xs mb-2",children:c.ingredients}),e.jsx("div",{className:"space-y-2",children:a.ingredients.map((s,r)=>e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs("select",{value:s.stockItemId,onChange:t=>j(r,"stockItemId",t.target.value),className:"flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-800/50 focus:border-primary-800",children:[e.jsx("option",{value:"",children:o("forms.mealForm.selectStock")}),p&&p.map(t=>e.jsxs("option",{value:t._id,children:[t.name," (",t.unit,")"]},t._id))]}),e.jsx("input",{type:"number",value:s.quantityUsed,onChange:t=>j(r,"quantityUsed",t.target.value),className:"w-20 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-800/50 focus:border-primary-800",placeholder:o("forms.mealForm.qty"),min:"0.01",step:"0.01"}),e.jsxs("select",{value:s.unit,onChange:t=>j(r,"unit",t.target.value),className:"w-20 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-800/50 focus:border-primary-800",children:[e.jsx("option",{value:"pcs",children:"pcs"}),e.jsx("option",{value:"kg",children:"kg"}),e.jsx("option",{value:"grams",children:"g"}),e.jsx("option",{value:"liters",children:"L"}),e.jsx("option",{value:"ml",children:"ml"}),e.jsx("option",{value:"cups",children:"cups"}),e.jsx("option",{value:"tsp",children:"tsp"}),e.jsx("option",{value:"tbsp",children:"tbsp"})]}),a.ingredients.length>1&&e.jsx("button",{type:"button",onClick:()=>L(r),className:"p-2 text-red-500 hover:text-red-700",children:e.jsx(G,{})})]},r))}),e.jsxs("button",{type:"button",onClick:_,className:"mt-2 flex items-center text-primary-800 hover:text-primary-900",children:[e.jsx(H,{className:"mr-1"})," ",o("forms.mealForm.addIngredient")]})]}),e.jsxs("div",{className:`flex justify-end space-x-3 pt-4 border-t border-gray-200 ${N?"space-x-reverse":""}`,children:[e.jsx("button",{type:"button",className:"btn-outline",onClick:h,disabled:I,children:o("common.cancel")}),e.jsx("button",{type:"submit",disabled:I,className:"px-4 py-2 rounded-md text-white font-medium transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-opacity-50 bg-primary-800 hover:bg-primary-800 focus:ring-primary-800/50 disabled:opacity-50",children:o(I?"forms.mealForm.saving":m?"forms.mealForm.updateMeal":"forms.mealForm.createMeal")})]})]})]})})};export{Q as default};
