const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/PrintReceiptModal-DdpT_Ork.js","assets/index-CCtTTFr5.js","assets/index-EF2iu2Sk.css"])))=>i.map(i=>d[i]);
import{j as s,u as A,a as Q,J as X,b as F,r as g,V as x,K as Y,L as N,y as Z,_ as O}from"./index-CCtTTFr5.js";const M=({label:n,value:m,onChange:l,placeholder:p="0",min:y="0",max:f,step:t="0.01",className:u=""})=>{const j=P=>{P.target.select()},e=P=>{const r=P.target.value;if(r==="")l("");else{const v=t==="1"?parseInt(r):parseFloat(r);l(isNaN(v)?"":v)}};return s.jsxs("div",{className:u,children:[n&&s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:n}),s.jsx("input",{type:"number",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent",value:m??"",onChange:e,onFocus:j,placeholder:p,min:y,max:f,step:t})]})};function T({value:n,onChange:m}){const{t:l}=A();return s.jsxs("select",{value:n,onChange:m,className:"w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500",children:[s.jsx("option",{value:"cash",children:l("cashier.cash")}),s.jsx("option",{value:"visa",children:l("payment.visa")})]})}const ee=({subtotal:n,discount:m,discountAmount:l,tax:p,taxAmount:y,finalTotal:f})=>{const{t}=A();return s.jsxs("div",{className:"bg-gray-50 rounded-lg p-2 sm:p-4 space-y-2",children:[s.jsxs("div",{className:"flex justify-between text-sm",children:[s.jsxs("span",{className:"text-gray-600",children:[t("cashier.subtotal"),":"]}),s.jsxs("span",{className:"font-medium",children:[n.toFixed(2)," AED"]})]}),s.jsxs("div",{className:"flex justify-between text-sm",children:[s.jsxs("span",{className:"text-gray-600",children:[t("cashier.discount")," (",m||0,"%):"]}),s.jsxs("span",{className:"font-medium text-red-600",children:["-",l.toFixed(2)," AED"]})]}),s.jsxs("div",{className:"flex justify-between text-sm",children:[s.jsxs("span",{className:"text-gray-600",children:[t("cashier.tax")," (",p||0,"%):"]}),s.jsxs("span",{className:"font-medium",children:["+",y.toFixed(2)," AED"]})]}),s.jsx("div",{className:"border-t border-gray-300 pt-2",children:s.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[s.jsxs("span",{children:[t("cashier.total"),":"]}),s.jsxs("span",{className:"text-primary-700",children:[f.toFixed(2)," AED"]})]})})]})};function se({paymentMode:n,setPaymentMode:m}){const{t:l}=A();return s.jsxs("div",{className:"flex bg-gray-100 rounded-lg p-1 mb-4",children:[s.jsx("button",{type:"button",onClick:()=>m("single"),className:`flex-1 py-2 px-4 text-sm font-medium rounded-md transition-colors ${n==="single"?"bg-white text-gray-900 shadow-sm":"text-gray-600 hover:text-gray-900"}`,children:l("payment.singlePayment")}),s.jsx("button",{type:"button",onClick:()=>m("split"),className:`flex-1 py-2 px-4 text-sm font-medium rounded-md transition-colors ${n==="split"?"bg-white text-gray-900 shadow-sm":"text-gray-600 hover:text-gray-900"}`,children:l("payment.splitPayment")})]})}const te=({payment:n,index:m,onMethodChange:l,onAmountChange:p,finalTotal:y})=>{const f=t=>{p(m,t);const u=m===0?1:0;if(p(u,""),t&&!isNaN(t)){const j=y-parseFloat(t);j>0?p(u,parseFloat(j.toFixed(2))):p(u,0)}};return s.jsxs("div",{className:"flex items-center space-x-3",children:[s.jsx("div",{className:"flex-1",children:s.jsx(T,{value:n.method,onChange:t=>l(m,t.target.value)})}),s.jsx("div",{className:"flex-1",children:s.jsx(M,{value:n.amount,onChange:f,placeholder:"0.00",min:"0",step:"1"})})]})},ae=g.lazy(()=>O(()=>import("./PrintReceiptModal-DdpT_Ork.js"),__vite__mapDeps([0,1,2])));function ie({tax:n,setTax:m,discount:l,setDiscount:p,subtotal:y,discountAmount:f}){const{t}=A(),u=Q(),j=X(),{currentOrder:e}=F(a=>a.order),{loading:P}=F(a=>a.payment),{currentShift:r}=F(a=>a.shift),{user:v}=F(a=>a.auth),[C,L]=g.useState("single"),[E,z]=g.useState("cash"),[_,k]=g.useState([{method:"cash",amount:""},{method:"visa",amount:""}]),[H,D]=g.useState(!1),[J,I]=g.useState(!1),R=y*(n||0)/100,h=y-f+R,K=g.useCallback((a,c)=>{k(i=>{const d=[...i];return d[a].method=c,d})},[]),U=g.useCallback((a,c)=>{k(i=>{const d=[...i];return d[a].amount=c,d})},[]),W=_.reduce((a,c)=>{const i=parseFloat(c.amount)||0;return a+i},0),V=h-W,q=()=>{const a=_.filter(i=>(parseFloat(i.amount)||0)>0);if(a.length===0)return{isValid:!1,message:t("payment.enterPaymentAmount")};const c=a.reduce((i,d)=>i+parseFloat(d.amount),0);if(c<h)return{isValid:!1,message:`${t("payment.needMoreAmount")} ${(h-c).toFixed(2)} AED`};if(c>h){const i=[...a];let d=h;for(let o=0;o<i.length;o++){const b=parseFloat(i[o].amount);if(d>=b)d-=b;else{i[o].amount=d,d=0,i.splice(o+1);break}}return{isValid:!0,payments:i}}return{isValid:!0,payments:a}},B=async()=>{var a,c,i,d;if(!e){x.error(t("payment.noOrderSelected"));return}if(e.isCancelled){x.error(t("payment.cannotPayCancelledOrder"));return}if(e.isPaid){x.error(t("payment.orderAlreadyPaid"));return}if(J){console.log("Payment already processed for this order");return}I(!0);try{let o=[];if(C==="single")o=[{method:E,amount:h}];else{const w=q();if(!w.isValid){x.error(w.message);return}o=w.payments.map($=>({method:$.method,amount:parseFloat($.amount)}))}if((await u(Y({orderId:e._id,paymentMethods:o,tax:n||0,discount:l||0})).unwrap()).alreadyPaid){x.success(t("payment.alreadyPaidSuccess"),{duration:3e3,icon:"✅"}),r!=null&&r._id?await u(N({shiftId:r._id})):await u(N()),setTimeout(()=>{j("/menu")},1500);return}r!=null&&r._id?await u(N({shiftId:r._id})):await u(N()),x.success(t("payment.paymentSuccess"),{duration:3e3,icon:"✅"}),setTimeout(()=>{j("/menu")},1500);const S={...e,orderNumber:e.orderCode||((a=e._id)==null?void 0:a.slice(-8))||"N/A",cashier:(v==null?void 0:v.name)||"System",paymentMethods:o,tax:n||0,discount:l||0,finalTotal:h,subtotal:y,orderItems:e.orderItems||[],orderItemsData:e.orderItemsData||[],custName:e.custName||"",custPhone:e.custPhone||e.custtPhone||"",custAddress:e.custAddress||""};try{await Z.printCustomerReceipt(S),console.log("✅ Customer receipt printed successfully to customer printer")}catch(w){console.warn("❌ Customer receipt print failed:",w)}}catch(o){console.error("Payment failed:",o),I(!1);let b=t("payment.paymentFailedRetry"),S=!1;if(o.shouldRetry?(b=o.message+" Would you like to try again?",S=!0):o.message&&(b=o.message),(c=o.message)!=null&&c.includes("already paid")||(d=(i=o.originalError)==null?void 0:i.message)!=null&&d.includes("already paid")){r!=null&&r._id?await u(N({shiftId:r._id})):await u(N()),x.error(t("payment.paymentStatusUnclear"),{duration:5e3,icon:"⚠️"});return}x.error(b,{duration:S?6e3:4e3,icon:"❌"})}};g.useEffect(()=>{I(!1)},[e==null?void 0:e._id]);const G=()=>{if(!e){x.error(t("payment.noOrderSelected"));return}if(e.isCancelled){x.error(t("payment.cannotPrintCancelledOrder"));return}D(!0)};return s.jsxs("div",{className:"bg-white rounded-lg shadow-card p-2 sm:p-6 space-y-6",children:[s.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[s.jsx(M,{label:t("payment.taxPercent"),value:n,onChange:m,placeholder:"0",min:"0",max:"100",step:"1"}),s.jsx(M,{label:t("payment.discountPercent"),value:l,onChange:p,placeholder:"0",min:"0",max:"100",step:"1"})]}),s.jsx(ee,{subtotal:y,discount:l,discountAmount:f,tax:n,taxAmount:R,finalTotal:h}),s.jsxs("div",{children:[s.jsx("label",{className:"hidden sm:block text-sm font-medium text-gray-700 mb-3",children:t("payment.paymentMethod")}),s.jsx(se,{paymentMode:C,setPaymentMode:L}),C==="single"&&s.jsx(T,{value:E,onChange:a=>z(a.target.value)}),C==="split"&&s.jsxs("div",{className:"space-y-3",children:[_.map((a,c)=>s.jsx(te,{payment:a,index:c,onMethodChange:K,onAmountChange:U,finalTotal:h},c)),s.jsxs("div",{className:"text-sm text-gray-600 bg-blue-50 p-2 rounded text-start",children:[t("payment.remaining"),":"," ",s.jsx("span",{className:`font-medium ${V>0?"text-red-600":"text-green-600"}`,children:V.toFixed(2)})]})]})]}),s.jsxs("div",{className:"space-y-3",children:[s.jsx("button",{onClick:B,disabled:P||!e||(e==null?void 0:e.isPaid)||(e==null?void 0:e.isCancelled),className:`w-full py-3 px-4 rounded-md transition-colors font-medium ${e!=null&&e.isPaid?"bg-green-100 text-green-800 cursor-not-allowed":e!=null&&e.isCancelled?"bg-red-100 text-red-800 cursor-not-allowed":"bg-green-600 text-white hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed"}`,children:e!=null&&e.isPaid?t("payment.orderAlreadyPaid"):e!=null&&e.isCancelled?t("payment.orderCancelled"):P?t("payment.processing"):`${t("payment.pay")} ${h.toFixed(2)} AED`}),s.jsx("button",{onClick:G,disabled:e==null?void 0:e.isCancelled,className:`w-full py-2 px-4 rounded-md transition-colors ${e!=null&&e.isCancelled?"bg-gray-400 text-gray-600 cursor-not-allowed":"bg-primary-700 text-white hover:bg-primary-800"}`,children:e!=null&&e.isCancelled?t("payment.cannotPrintCancelled"):e!=null&&e.isPaid?t("payment.printReceipt"):t("payment.printPreview")})]}),H&&s.jsx(g.Suspense,{fallback:s.jsx("div",{children:t("common.loading")}),children:s.jsx(ae,{order:e,onClose:()=>D(!1)})})]})}export{ie as default};
