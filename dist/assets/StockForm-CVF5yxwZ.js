import{u as X,a as Y,b as D,r as b,j as e,M as Z,f as E,g as M,h as V}from"./index-COiNFfFw.js";function re({stock:a=null,onClose:w,isViewMode:o=!1}){const{t:r,i18n:R}=X(),T=R.language==="ar",S=Y(),{loading:A,error:Q,stocks:g}=D(t=>t.stock),{user:m}=D(t=>t.auth),u=!!a&&!o,[n,I]=b.useState({name:(a==null?void 0:a.nameOfItem)||(a==null?void 0:a.name)||"",supplierName:(a==null?void 0:a.supplierName)||"",quantity:(a==null?void 0:a.quantity)||"",unit:(a==null?void 0:a.unit)||"pcs",pricePerUnit:(a==null?void 0:a.pricePerUnit)||(a==null?void 0:a.price)||"",minimumQuantity:(a==null?void 0:a.minimumQuantity)||"",managerId:(a==null?void 0:a.managerId)||(m==null?void 0:m._id)||"",invoiceType:"Cash",paidAmount:""}),[s,$]=b.useState({}),[L,N]=b.useState([]),[q,v]=b.useState(!1),[j,C]=b.useState(!0),[d,k]=b.useState(null);b.useEffect(()=>{var t;if(a){const i=(t=a.invoice)==null?void 0:t[0],l=a.quantity*(a.pricePerUnit||a.price||0),c=i?l-(i.residualValue||0):l;I({name:a.nameOfItem||a.name||"",supplierName:a.supplierName||"",quantity:a.quantity||"",unit:a.unit||"pcs",pricePerUnit:a.pricePerUnit||a.price||"",minimumQuantity:a.minimumQuantity||"",managerId:a.managerId||(m==null?void 0:m._id)||"",invoiceType:(i==null?void 0:i.type)||"Cash",paidAmount:c||""}),C(!1),k(a)}},[a,m]),b.useEffect(()=>{if(!a&&q)if(n.name&&n.name.length>=1){const t=g.filter(i=>i.name.toLowerCase().includes(n.name.toLowerCase()));N(t),v(t.length>0)}else n.name===""&&q&&(N(g),v(g.length>0));else(a||!q)&&(N([]),v(!1))},[n.name,g,a,q]);const _=()=>{if(!a&&!o){if(v(!0),n.name.trim()==="")N(g);else if(n.name.length>=1){const t=g.filter(i=>i.name.toLowerCase().includes(n.name.toLowerCase()));N(t)}}},B=()=>{setTimeout(()=>{v(!1),N([])},200)},F=()=>{const t=Number(n.quantity)||0,i=Number(n.pricePerUnit)||0;return(t*i).toFixed(2)},O=()=>{const t=Number(F())||0,i=Number(n.paidAmount)||0;return Math.max(0,t-i).toFixed(2)},W=()=>{const t=Number(F()),i=Number(n.paidAmount)||0;return i<=0?{status:"Not Paid",color:"red"}:i>=t?{status:"Fully Paid",color:"green"}:{status:"Partial Payment",color:"yellow"}},z=t=>{k(t),C(!1),I({name:t.name,supplierName:t.supplierName,quantity:t.quantity,unit:t.unit,pricePerUnit:t.pricePerUnit,minimumQuantity:t.minimumQuantity||"",managerId:t.managerId||(m==null?void 0:m._id)||"",invoiceType:"Cash",paidAmount:""}),v(!1)},f=t=>{const{name:i,value:l,type:c}=t.target;let P=c==="number"?l===""?"":Number(l):l;I(p=>{const x={...p,[i]:P};if(i==="name"&&d&&(g.find(h=>h.name.toLowerCase()===l.toLowerCase())||(k(null),C(!0))),i==="invoiceType")if(l==="Cash"){const y=(Number(p.quantity)||0)*(Number(p.pricePerUnit)||0);x.paidAmount=y}else x.paidAmount=x.paidAmount||0;if((i==="quantity"||i==="pricePerUnit")&&x.invoiceType==="Cash"){const y=i==="quantity"?P:p.quantity,h=i==="pricePerUnit"?P:p.pricePerUnit,K=(Number(y)||0)*(Number(h)||0);x.paidAmount=K}return x}),s[i]&&$(p=>({...p,[i]:""}))},G=()=>{const t={};n.name.trim()||(t.name=r("forms.stockForm.nameRequired")),n.supplierName.trim()||(t.supplierName=r("forms.stockForm.supplierRequired")),(!n.quantity||n.quantity<=0)&&(t.quantity=r("forms.stockForm.quantityRequired")),(!n.pricePerUnit||n.pricePerUnit<=0)&&(t.pricePerUnit=r("forms.stockForm.priceRequired")),n.minimumQuantity!==""&&n.minimumQuantity<0&&(t.minimumQuantity="Minimum quantity cannot be negative");const i=n.managerId||(m==null?void 0:m._id);if(i?/^[0-9a-fA-F]{24}$/.test(i)||(t.managerId="Invalid manager ID format"):t.managerId="Manager ID is required",!u&&!o&&j){const l=Number(F()),c=Number(n.paidAmount)||0;l<=0&&(t.pricePerUnit="Total cost must be greater than 0"),c<0&&(t.paidAmount="Paid amount cannot be negative"),c>l&&(t.paidAmount="Paid amount cannot exceed total cost"),n.invoiceType==="Postponed"&&c===l&&(t.paidAmount="For postponed payments, paid amount should be less than total")}return $(t),Object.keys(t).length===0},H=async t=>{var i;if(t.preventDefault(),!!G())try{const l=n.managerId||(m==null?void 0:m._id),c=Number(F()),P=Number(n.paidAmount)||0,p=Math.max(0,c-P),x={name:n.name,supplierName:n.supplierName,quantity:Number(n.quantity),pricePerUnit:Number(n.pricePerUnit),unit:n.unit,minimumQuantity:Number(n.minimumQuantity)||0,managerId:l};if(u)await S(E({stockId:a._id,stockData:x})).unwrap();else if(d&&!j){const y={...x,quantity:Number(d.quantity)+Number(n.quantity)},h=(i=d.invoice)==null?void 0:i[0];h?y.invoice=[{type:n.invoiceType,value:h.value+c,residualValue:h.residualValue+p}]:y.invoice=[{type:n.invoiceType,value:c,residualValue:p}],await S(E({stockId:d._id,stockData:y})).unwrap()}else x.invoice=[{type:n.invoiceType,value:c,residualValue:p}],await S(M(x)).unwrap();S(V()),w()}catch(l){console.error("Error saving stock:",l)}},J=()=>o?r("forms.stockForm.viewStock"):u?r("forms.stockForm.editStock"):d&&!j?`${r("forms.stockForm.updateStock")}: ${d.name}`:r("forms.stockForm.addStock"),U=W();return e.jsx(Z,{title:J(),onClose:w,children:e.jsx("div",{className:"space-y-4",dir:T?"rtl":"ltr",children:e.jsxs("form",{onSubmit:H,children:[Q&&e.jsx("div",{className:"p-3 bg-red-100 border border-red-400 text-red-700 rounded-md text-sm",children:Q}),e.jsxs("div",{className:"relative",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[r("forms.stockForm.itemName")," *"]}),e.jsx("input",{type:"text",name:"name",value:n.name,onChange:f,className:`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 ${s.name?"border-red-500":"border-gray-300"}`,placeholder:r("forms.stockForm.enterItemName"),required:!0,onFocus:_,onBlur:B}),s.name&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:s.name}),q&&L.length>0&&!o&&e.jsxs("div",{className:"absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-48 overflow-y-auto",children:[e.jsx("div",{className:"p-2 bg-blue-50 border-b text-xs text-blue-700",children:r("forms.stockForm.existingStocksFound")}),L.map(t=>e.jsxs("div",{className:"p-3 hover:bg-gray-50 cursor-pointer border-b last:border-b-0",onClick:()=>z(t),children:[e.jsx("div",{className:"font-medium text-gray-900",children:t.name}),e.jsxs("div",{className:"text-sm text-gray-600",children:[r("forms.stockForm.currentQuantityLabel"),":"," ",t.quantity," ",t.unit," |",r("forms.stockForm.supplierName"),":"," ",t.supplierName," | $",t.pricePerUnit,"/",t.unit]}),t.minimumQuantity>0&&e.jsxs("div",{className:"text-xs text-orange-600",children:[r("forms.stockForm.minStockLevel"),":"," ",t.minimumQuantity," ",t.unit]})]},t._id))]}),d&&!j&&!u&&e.jsx("div",{className:"mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded-md",children:e.jsxs("p",{className:"text-sm text-yellow-800",children:[e.jsxs("strong",{children:[r("forms.stockForm.updateMode"),":"]})," ",r("forms.stockForm.addingToExistingStock"),' "',d.name,'".'," ",r("forms.stockForm.currentQuantityLabel"),":"," ",d.quantity," ",d.unit]})})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[r("forms.stockForm.supplierName")," *"]}),e.jsx("input",{type:"text",name:"supplierName",value:n.supplierName,onChange:f,className:`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 ${s.supplierName?"border-red-500":"border-gray-300"}`,placeholder:r("forms.stockForm.enterSupplierName"),required:!0}),s.supplierName&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:s.supplierName})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[r("forms.stockForm.quantity")," *"," ",d&&!j&&!u&&`(${r("forms.stockForm.additionalQuantity")})`]}),e.jsx("input",{type:"number",name:"quantity",value:n.quantity,onChange:f,className:`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 ${s.quantity?"border-red-500":"border-gray-300"}`,placeholder:r(d&&!j&&!u?"forms.stockForm.enterAdditionalQuantity":"forms.stockForm.enterQuantity"),min:"0",step:"0.01",required:!o}),s.quantity&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:s.quantity})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[r("forms.stockForm.unit")," *"]}),e.jsxs("select",{name:"unit",value:n.unit,onChange:f,className:`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 ${o?"bg-gray-100":"border-gray-300"}`,required:!o,disabled:o,children:[e.jsx("option",{value:"pcs",children:r("forms.stockForm.pieces")}),e.jsx("option",{value:"kg",children:r("forms.stockForm.kilogram")}),e.jsx("option",{value:"grams",children:r("forms.stockForm.grams")}),e.jsx("option",{value:"liters",children:r("forms.stockForm.liters")}),e.jsx("option",{value:"ml",children:r("forms.stockForm.milliliters")}),e.jsx("option",{value:"cans",children:r("forms.stockForm.cans")}),e.jsx("option",{value:"cups",children:r("forms.stockForm.cups")}),e.jsx("option",{value:"tsp",children:r("forms.stockForm.teaspoon")}),e.jsx("option",{value:"tbsp",children:r("forms.stockForm.tablespoon")}),e.jsx("option",{value:"packets",children:r("forms.stockForm.packets")}),e.jsx("option",{value:"boxes",children:r("forms.stockForm.boxes")})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[r("forms.stockForm.pricePerUnit")," ($) *"]}),e.jsx("input",{type:"number",name:"pricePerUnit",value:n.pricePerUnit,onChange:f,className:`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 ${s.pricePerUnit?"border-red-500":"border-gray-300"}`,placeholder:r("forms.stockForm.enterPricePerUnit"),min:"0",step:"0.01",required:!o}),s.pricePerUnit&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:s.pricePerUnit})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:r("forms.stockForm.minStockLevel")}),e.jsx("input",{type:"number",name:"minimumQuantity",value:n.minimumQuantity,onChange:f,className:`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 ${s.minimumQuantity?"border-red-500":"border-gray-300"}`,placeholder:r("forms.stockForm.enterMinLevel"),min:"0",step:"1"}),s.minimumQuantity&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:s.minimumQuantity}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:r("forms.stockForm.getNotifiedWhenStockFallsBelowLevel")})]})]}),n.quantity&&n.pricePerUnit&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-md p-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("span",{className:"text-sm font-medium text-blue-800",children:[r("forms.stockForm.totalValue"),":"]}),e.jsxs("span",{className:"text-lg font-bold text-blue-900",children:["$",F()]})]}),e.jsxs("p",{className:"text-xs text-blue-600 mt-1",children:[n.quantity," ",n.unit," × $",n.pricePerUnit," ",r("forms.stockForm.per")," ",n.unit]})]}),s.managerId&&e.jsx("div",{className:"p-3 bg-red-100 border border-red-400 text-red-700 rounded-md text-sm",children:s.managerId}),(!u||u&&n.invoiceType==="Postponed")&&e.jsxs("div",{className:"border-t pt-4",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:r("forms.stockForm.paymentType")}),e.jsxs("select",{name:"invoiceType",value:n.invoiceType,onChange:f,className:"w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-gray-100",children:[e.jsx("option",{value:"Cash",children:r("forms.stockForm.cash")}),e.jsx("option",{value:"Postponed",children:r("forms.stockForm.postponed")})]}),u&&e.jsx("p",{className:"text-xs text-blue-600 mt-1",children:r("forms.stockForm.noteEditingPaymentTypeWillAffectFinancialRecords")})]}),(n.invoiceType==="Postponed"||u)&&e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[r("forms.stockForm.paidAmount")," ($)"," ",!o&&!u&&"*"]}),e.jsx("input",{type:"number",name:"paidAmount",value:n.paidAmount,onChange:f,className:`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 ${s.paidAmount?"border-red-500":"border-gray-300"} ${o||!u&&n.invoiceType==="Cash"?"bg-gray-100":""}`,placeholder:r("forms.stockForm.enterPaidAmount"),min:"0",max:F(),step:"0.01",required:!o&&!u&&n.invoiceType==="Postponed"}),s.paidAmount&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:s.paidAmount})]}),n.quantity&&n.pricePerUnit&&e.jsx("div",{className:`p-4 rounded-md border ${U.color==="green"?"bg-green-50 border-green-200":U.color==="yellow"?"bg-yellow-50 border-yellow-200":"bg-red-50 border-red-200"}`,children:e.jsx("div",{className:"grid grid-cols-2 gap-4 text-sm",children:e.jsx("div",{children:e.jsxs("span",{className:`font-medium ${U.color==="green"?"text-green-800":U.color==="yellow"?"text-yellow-800":"text-red-800"}`,children:[r("forms.stockForm.remaining"),": $",O()]})})})})]}),o&&a&&e.jsxs("div",{className:"border-t pt-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-800 mb-3",children:r("forms.stockForm.additionalInformation")}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsxs("span",{className:"font-medium text-gray-700",children:[r("forms.stockForm.created"),":"]}),e.jsx("p",{className:"text-gray-600",children:new Date(a.createdAt).toLocaleDateString()})]}),e.jsxs("div",{children:[e.jsxs("span",{className:"font-medium text-gray-700",children:[r("forms.stockForm.lastUpdated"),":"]}),e.jsx("p",{className:"text-gray-600",children:new Date(a.updatedAt).toLocaleDateString()})]}),e.jsx("div",{})]})]}),e.jsxs("div",{className:`flex justify-end space-x-3 pt-4 border-t border-gray-200 ${T?"space-x-reverse":""}`,children:[e.jsx("button",{type:"button",className:"px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2",onClick:w,disabled:A&&!o,children:r(o?"common.close":"common.cancel")}),!o&&e.jsx("button",{type:"submit",disabled:A,className:"px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed",children:r(A?"forms.stockForm.saving":u?"forms.stockForm.updateStock":"forms.stockForm.createStock")})]})]})})})}export{re as default};
