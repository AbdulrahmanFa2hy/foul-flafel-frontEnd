const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/PrintReceiptModal-Bhc6WFIW.js","assets/index-Bm0RCD-2.js","assets/index-B6ssL130.css"])))=>i.map(i=>d[i]);
import{j as e,u as w,a as W,J as q,b as S,r as j,V as f,K as B,L as P,_ as G}from"./index-Bm0RCD-2.js";const A=({label:r,value:c,onChange:o,placeholder:u="0",min:x="0",max:g,step:t="0.01",className:m=""})=>{const b=N=>{N.target.select()},n=N=>{const l=N.target.value;if(l==="")o("");else{const v=t==="1"?parseInt(l):parseFloat(l);o(isNaN(v)?"":v)}};return e.jsxs("div",{className:m,children:[r&&e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:r}),e.jsx("input",{type:"number",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent",value:c??"",onChange:n,onFocus:b,placeholder:u,min:x,max:g,step:t})]})};function I({value:r,onChange:c}){const{t:o}=w();return e.jsxs("select",{value:r,onChange:c,className:"w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500",children:[e.jsx("option",{value:"cash",children:o("cashier.cash")}),e.jsx("option",{value:"visa",children:o("payment.visa")})]})}const H=({subtotal:r,discount:c,discountAmount:o,tax:u,taxAmount:x,finalTotal:g})=>{const{t}=w();return e.jsxs("div",{className:"bg-gray-50 rounded-lg p-2 sm:p-4 space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-gray-600",children:[t("cashier.subtotal"),":"]}),e.jsxs("span",{className:"font-medium",children:[r.toFixed(2)," AED"]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-gray-600",children:[t("cashier.discount")," (",c||0,"%):"]}),e.jsxs("span",{className:"font-medium text-red-600",children:["-",o.toFixed(2)," AED"]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-gray-600",children:[t("cashier.tax")," (",u||0,"%):"]}),e.jsxs("span",{className:"font-medium",children:["+",x.toFixed(2)," AED"]})]}),e.jsx("div",{className:"border-t border-gray-300 pt-2",children:e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsxs("span",{children:[t("cashier.total"),":"]}),e.jsxs("span",{className:"text-primary-700",children:[g.toFixed(2)," AED"]})]})})]})};function O({paymentMode:r,setPaymentMode:c}){const{t:o}=w();return e.jsxs("div",{className:"flex bg-gray-100 rounded-lg p-1 mb-4",children:[e.jsx("button",{type:"button",onClick:()=>c("single"),className:`flex-1 py-2 px-4 text-sm font-medium rounded-md transition-colors ${r==="single"?"bg-white text-gray-900 shadow-sm":"text-gray-600 hover:text-gray-900"}`,children:o("payment.singlePayment")}),e.jsx("button",{type:"button",onClick:()=>c("split"),className:`flex-1 py-2 px-4 text-sm font-medium rounded-md transition-colors ${r==="split"?"bg-white text-gray-900 shadow-sm":"text-gray-600 hover:text-gray-900"}`,children:o("payment.splitPayment")})]})}const Q=({payment:r,index:c,onMethodChange:o,onAmountChange:u,finalTotal:x})=>{const g=t=>{u(c,t);const m=c===0?1:0;if(u(m,""),t&&!isNaN(t)){const b=x-parseFloat(t);b>0?u(m,parseFloat(b.toFixed(2))):u(m,0)}};return e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"flex-1",children:e.jsx(I,{value:r.method,onChange:t=>o(c,t.target.value)})}),e.jsx("div",{className:"flex-1",children:e.jsx(A,{value:r.amount,onChange:g,placeholder:"0.00",min:"0",step:"1"})})]})},X=j.lazy(()=>G(()=>import("./PrintReceiptModal-Bhc6WFIW.js"),__vite__mapDeps([0,1,2])));function Z({tax:r,setTax:c,discount:o,setDiscount:u,subtotal:x,discountAmount:g}){const{t}=w(),m=W(),b=q(),{currentOrder:n}=S(a=>a.order),{loading:N}=S(a=>a.payment),{currentShift:l}=S(a=>a.shift),[v,R]=j.useState("single"),[C,D]=j.useState("cash"),[F,_]=j.useState([{method:"cash",amount:""},{method:"visa",amount:""}]),[$,M]=j.useState(!1),k=x*(r||0)/100,y=x-g+k,T=j.useCallback((a,d)=>{_(i=>{const s=[...i];return s[a].method=d,s})},[]),L=j.useCallback((a,d)=>{_(i=>{const s=[...i];return s[a].amount=d,s})},[]),z=F.reduce((a,d)=>{const i=parseFloat(d.amount)||0;return a+i},0),E=y-z,J=()=>{const a=F.filter(i=>(parseFloat(i.amount)||0)>0);if(a.length===0)return{isValid:!1,message:t("payment.enterPaymentAmount")};const d=a.reduce((i,s)=>i+parseFloat(s.amount),0);if(d<y)return{isValid:!1,message:`${t("payment.needMoreAmount")} ${(y-d).toFixed(2)} AED`};if(d>y){const i=[...a];let s=y;for(let p=0;p<i.length;p++){const h=parseFloat(i[p].amount);if(s>=h)s-=h;else{i[p].amount=s,s=0,i.splice(p+1);break}}return{isValid:!0,payments:i}}return{isValid:!0,payments:a}},K=async()=>{var a,d,i;if(!n){f.error(t("payment.noOrderSelected"));return}if(n.isPaid){f.error(t("payment.orderAlreadyPaid"));return}try{let s=[];if(v==="single")s=[{method:C,amount:y}];else{const h=J();if(!h.isValid){f.error(h.message);return}s=h.payments.map(V=>({method:V.method,amount:parseFloat(V.amount)}))}if((await m(B({orderId:n._id,paymentMethods:s,tax:r||0,discount:o||0})).unwrap()).alreadyPaid){f.success(t("payment.alreadyPaidSuccess"),{duration:3e3,icon:"✅"}),l!=null&&l._id?await m(P({shiftId:l._id})):await m(P()),setTimeout(()=>{b("/menu")},1500);return}l!=null&&l._id?await m(P({shiftId:l._id})):await m(P()),f.success(t("payment.paymentSuccess"),{duration:3e3,icon:"✅"}),setTimeout(()=>{b("/menu")},1500)}catch(s){console.error("Payment failed:",s);let p=t("payment.paymentFailedRetry"),h=!1;if(s.shouldRetry?(p=s.message+" Would you like to try again?",h=!0):s.message&&(p=s.message),(a=s.message)!=null&&a.includes("already paid")||(i=(d=s.originalError)==null?void 0:d.message)!=null&&i.includes("already paid")){l!=null&&l._id?await m(P({shiftId:l._id})):await m(P()),f.error(t("payment.paymentStatusUnclear"),{duration:5e3,icon:"⚠️"});return}f.error(p,{duration:h?6e3:4e3,icon:"❌"})}},U=()=>{if(!n){f.error(t("payment.noOrderSelected"));return}M(!0)};return e.jsxs("div",{className:"bg-white rounded-lg shadow-card p-2 sm:p-6 space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(A,{label:t("payment.taxPercent"),value:r,onChange:c,placeholder:"0",min:"0",max:"100",step:"1"}),e.jsx(A,{label:t("payment.discountPercent"),value:o,onChange:u,placeholder:"0",min:"0",max:"100",step:"1"})]}),e.jsx(H,{subtotal:x,discount:o,discountAmount:g,tax:r,taxAmount:k,finalTotal:y}),e.jsxs("div",{children:[e.jsx("label",{className:"hidden sm:block text-sm font-medium text-gray-700 mb-3",children:t("payment.paymentMethod")}),e.jsx(O,{paymentMode:v,setPaymentMode:R}),v==="single"&&e.jsx(I,{value:C,onChange:a=>D(a.target.value)}),v==="split"&&e.jsxs("div",{className:"space-y-3",children:[F.map((a,d)=>e.jsx(Q,{payment:a,index:d,onMethodChange:T,onAmountChange:L,finalTotal:y},d)),e.jsxs("div",{className:"text-sm text-gray-600 bg-blue-50 p-2 rounded text-start",children:[t("payment.remaining"),":"," ",e.jsx("span",{className:`font-medium ${E>0?"text-red-600":"text-green-600"}`,children:E.toFixed(2)})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{onClick:K,disabled:N||!n||(n==null?void 0:n.isPaid),className:`w-full py-3 px-4 rounded-md transition-colors font-medium ${n!=null&&n.isPaid?"bg-green-100 text-green-800 cursor-not-allowed":"bg-green-600 text-white hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed"}`,children:n!=null&&n.isPaid?t("payment.orderAlreadyPaid"):N?t("payment.processing"):`${t("payment.pay")} ${y.toFixed(2)} AED`}),e.jsx("button",{onClick:U,className:"w-full py-2 px-4 bg-primary-700 text-white rounded-md hover:bg-primary-800 transition-colors",children:n!=null&&n.isPaid?t("payment.printReceipt"):t("payment.printPreview")})]}),$&&e.jsx(j.Suspense,{fallback:e.jsx("div",{children:t("common.loading")}),children:e.jsx(X,{order:n,onClose:()=>M(!1)})})]})}export{Z as default};
