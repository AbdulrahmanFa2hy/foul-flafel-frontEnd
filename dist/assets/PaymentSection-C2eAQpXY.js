const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/PrintReceiptModal-Bu5ghZjn.js","assets/index-BtMgr77z.js","assets/index-Dl82hVbz.css"])))=>i.map(i=>d[i]);
import{j as e,u as C,a as O,J as Q,b as A,r as f,V as p,K as X,L as w,y as V,_ as Y}from"./index-BtMgr77z.js";const E=({label:l,value:m,onChange:d,placeholder:h="0",min:x="0",max:g,step:t="0.01",className:u=""})=>{const j=v=>{v.target.select()},s=v=>{const c=v.target.value;if(c==="")d("");else{const P=t==="1"?parseInt(c):parseFloat(c);d(isNaN(P)?"":P)}};return e.jsxs("div",{className:u,children:[l&&e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:l}),e.jsx("input",{type:"number",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent",value:m??"",onChange:s,onFocus:j,placeholder:h,min:x,max:g,step:t})]})};function T({value:l,onChange:m}){const{t:d}=C();return e.jsxs("select",{value:l,onChange:m,className:"w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500",children:[e.jsx("option",{value:"cash",children:d("cashier.cash")}),e.jsx("option",{value:"visa",children:d("payment.visa")})]})}const Z=({subtotal:l,discount:m,discountAmount:d,tax:h,taxAmount:x,finalTotal:g})=>{const{t}=C();return e.jsxs("div",{className:"bg-gray-50 rounded-lg p-2 sm:p-4 space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-gray-600",children:[t("cashier.subtotal"),":"]}),e.jsxs("span",{className:"font-medium",children:[l.toFixed(2)," AED"]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-gray-600",children:[t("cashier.discount")," (",m||0,"%):"]}),e.jsxs("span",{className:"font-medium text-red-600",children:["-",d.toFixed(2)," AED"]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-gray-600",children:[t("cashier.tax")," (",h||0,"%):"]}),e.jsxs("span",{className:"font-medium",children:["+",x.toFixed(2)," AED"]})]}),e.jsx("div",{className:"border-t border-gray-300 pt-2",children:e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsxs("span",{children:[t("cashier.total"),":"]}),e.jsxs("span",{className:"text-primary-700",children:[g.toFixed(2)," AED"]})]})})]})};function ee({paymentMode:l,setPaymentMode:m}){const{t:d}=C();return e.jsxs("div",{className:"flex bg-gray-100 rounded-lg p-1 mb-4",children:[e.jsx("button",{type:"button",onClick:()=>m("single"),className:`flex-1 py-2 px-4 text-sm font-medium rounded-md transition-colors ${l==="single"?"bg-white text-gray-900 shadow-sm":"text-gray-600 hover:text-gray-900"}`,children:d("payment.singlePayment")}),e.jsx("button",{type:"button",onClick:()=>m("split"),className:`flex-1 py-2 px-4 text-sm font-medium rounded-md transition-colors ${l==="split"?"bg-white text-gray-900 shadow-sm":"text-gray-600 hover:text-gray-900"}`,children:d("payment.splitPayment")})]})}const te=({payment:l,index:m,onMethodChange:d,onAmountChange:h,finalTotal:x})=>{const g=t=>{h(m,t);const u=m===0?1:0;if(h(u,""),t&&!isNaN(t)){const j=x-parseFloat(t);j>0?h(u,parseFloat(j.toFixed(2))):h(u,0)}};return e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"flex-1",children:e.jsx(T,{value:l.method,onChange:t=>d(m,t.target.value)})}),e.jsx("div",{className:"flex-1",children:e.jsx(E,{value:l.amount,onChange:g,placeholder:"0.00",min:"0",step:"1"})})]})},se=f.lazy(()=>Y(()=>import("./PrintReceiptModal-Bu5ghZjn.js"),__vite__mapDeps([0,1,2])));function ie({tax:l,setTax:m,discount:d,setDiscount:h,subtotal:x,discountAmount:g}){const{t}=C(),u=O(),j=Q(),{currentOrder:s}=A(a=>a.order),{loading:v}=A(a=>a.payment),{currentShift:c}=A(a=>a.shift),{user:P}=A(a=>a.auth),[F,L]=f.useState("single"),[I,z]=f.useState("cash"),[_,M]=f.useState([{method:"cash",amount:""},{method:"visa",amount:""}]),[B,R]=f.useState(!1),k=x*(l||0)/100,y=x-g+k,J=async a=>{try{const i=await V.printBothReceipts(a),n=i.filter(r=>r.success).length,o=i.filter(r=>!r.success).length;n>0&&o===0||(n>0&&o>0?p.success(`${n} ${t("payment.someReceiptsFailed")} ${o}`,{icon:"⚠️"}):p.error(t("payment.printFailed"),{icon:"❌"}))}catch(i){console.error("Auto-print failed:",i),p.error(t("payment.autoPrintFailed"))}},K=f.useCallback((a,i)=>{M(n=>{const o=[...n];return o[a].method=i,o})},[]),U=f.useCallback((a,i)=>{M(n=>{const o=[...n];return o[a].amount=i,o})},[]),W=_.reduce((a,i)=>{const n=parseFloat(i.amount)||0;return a+n},0),D=y-W,q=()=>{const a=_.filter(n=>(parseFloat(n.amount)||0)>0);if(a.length===0)return{isValid:!1,message:t("payment.enterPaymentAmount")};const i=a.reduce((n,o)=>n+parseFloat(o.amount),0);if(i<y)return{isValid:!1,message:`${t("payment.needMoreAmount")} ${(y-i).toFixed(2)} AED`};if(i>y){const n=[...a];let o=y;for(let r=0;r<n.length;r++){const b=parseFloat(n[r].amount);if(o>=b)o-=b;else{n[r].amount=o,o=0,n.splice(r+1);break}}return{isValid:!0,payments:n}}return{isValid:!0,payments:a}},G=async()=>{var a,i,n,o;if(!s){p.error(t("payment.noOrderSelected"));return}if(s.isPaid){p.error(t("payment.orderAlreadyPaid"));return}try{let r=[];if(F==="single")r=[{method:I,amount:y}];else{const N=q();if(!N.isValid){p.error(N.message);return}r=N.payments.map($=>({method:$.method,amount:parseFloat($.amount)}))}if((await u(X({orderId:s._id,paymentMethods:r,tax:l||0,discount:d||0})).unwrap()).alreadyPaid){p.success(t("payment.alreadyPaidSuccess"),{duration:3e3,icon:"✅"}),c!=null&&c._id?await u(w({shiftId:c._id})):await u(w()),setTimeout(()=>{j("/menu")},1500);return}c!=null&&c._id?await u(w({shiftId:c._id})):await u(w()),p.success(t("payment.paymentSuccess"),{duration:3e3,icon:"✅"}),setTimeout(()=>{j("/menu")},1500);const S={...s,orderNumber:s.orderCode||((a=s._id)==null?void 0:a.slice(-8))||"N/A",cashier:(P==null?void 0:P.name)||"System",paymentMethods:r,tax:l||0,discount:d||0,finalTotal:y,orderItems:s.orderItems||[],orderItemsData:s.orderItemsData||[],custName:s.custName||"",custPhone:s.custPhone||s.custtPhone||"",custAddress:s.custAddress||""};V.getPrinterSettings().some(N=>N.enabled&&N.autoPrint)&&J(S)}catch(r){console.error("Payment failed:",r);let b=t("payment.paymentFailedRetry"),S=!1;if(r.shouldRetry?(b=r.message+" Would you like to try again?",S=!0):r.message&&(b=r.message),(i=r.message)!=null&&i.includes("already paid")||(o=(n=r.originalError)==null?void 0:n.message)!=null&&o.includes("already paid")){c!=null&&c._id?await u(w({shiftId:c._id})):await u(w()),p.error(t("payment.paymentStatusUnclear"),{duration:5e3,icon:"⚠️"});return}p.error(b,{duration:S?6e3:4e3,icon:"❌"})}},H=()=>{if(!s){p.error(t("payment.noOrderSelected"));return}R(!0)};return e.jsxs("div",{className:"bg-white rounded-lg shadow-card p-2 sm:p-6 space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(E,{label:t("payment.taxPercent"),value:l,onChange:m,placeholder:"0",min:"0",max:"100",step:"1"}),e.jsx(E,{label:t("payment.discountPercent"),value:d,onChange:h,placeholder:"0",min:"0",max:"100",step:"1"})]}),e.jsx(Z,{subtotal:x,discount:d,discountAmount:g,tax:l,taxAmount:k,finalTotal:y}),e.jsxs("div",{children:[e.jsx("label",{className:"hidden sm:block text-sm font-medium text-gray-700 mb-3",children:t("payment.paymentMethod")}),e.jsx(ee,{paymentMode:F,setPaymentMode:L}),F==="single"&&e.jsx(T,{value:I,onChange:a=>z(a.target.value)}),F==="split"&&e.jsxs("div",{className:"space-y-3",children:[_.map((a,i)=>e.jsx(te,{payment:a,index:i,onMethodChange:K,onAmountChange:U,finalTotal:y},i)),e.jsxs("div",{className:"text-sm text-gray-600 bg-blue-50 p-2 rounded text-start",children:[t("payment.remaining"),":"," ",e.jsx("span",{className:`font-medium ${D>0?"text-red-600":"text-green-600"}`,children:D.toFixed(2)})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{onClick:G,disabled:v||!s||(s==null?void 0:s.isPaid),className:`w-full py-3 px-4 rounded-md transition-colors font-medium ${s!=null&&s.isPaid?"bg-green-100 text-green-800 cursor-not-allowed":"bg-green-600 text-white hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed"}`,children:s!=null&&s.isPaid?t("payment.orderAlreadyPaid"):v?t("payment.processing"):`${t("payment.pay")} ${y.toFixed(2)} AED`}),e.jsx("button",{onClick:H,className:"w-full py-2 px-4 bg-primary-700 text-white rounded-md hover:bg-primary-800 transition-colors",children:s!=null&&s.isPaid?t("payment.printReceipt"):t("payment.printPreview")})]}),B&&e.jsx(f.Suspense,{fallback:e.jsx("div",{children:t("common.loading")}),children:e.jsx(se,{order:s,onClose:()=>R(!1)})})]})}export{ie as default};
