const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/PrintReceiptModal-Bx7Ija2Q.js","assets/index-CzLutvYC.js","assets/index-3IXj75bd.css"])))=>i.map(i=>d[i]);
import{j as e,u as A,a as Q,J as X,b as F,r as h,V as f,K as Y,L as N,y as Z,_ as O}from"./index-CzLutvYC.js";const M=({label:n,value:m,onChange:r,placeholder:y="0",min:x="0",max:g,step:s="0.01",className:u=""})=>{const j=v=>{v.target.select()},t=v=>{const l=v.target.value;if(l==="")r("");else{const P=s==="1"?parseInt(l):parseFloat(l);r(isNaN(P)?"":P)}};return e.jsxs("div",{className:u,children:[n&&e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:n}),e.jsx("input",{type:"number",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent",value:m??"",onChange:t,onFocus:j,placeholder:y,min:x,max:g,step:s})]})};function T({value:n,onChange:m}){const{t:r}=A();return e.jsxs("select",{value:n,onChange:m,className:"w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500",children:[e.jsx("option",{value:"cash",children:r("cashier.cash")}),e.jsx("option",{value:"visa",children:r("payment.visa")})]})}const ee=({subtotal:n,discount:m,discountAmount:r,tax:y,taxAmount:x,finalTotal:g})=>{const{t:s}=A();return e.jsxs("div",{className:"bg-gray-50 rounded-lg p-2 sm:p-4 space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-gray-600",children:[s("cashier.subtotal"),":"]}),e.jsxs("span",{className:"font-medium",children:[n.toFixed(2)," AED"]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-gray-600",children:[s("cashier.discount")," (",m||0,"%):"]}),e.jsxs("span",{className:"font-medium text-red-600",children:["-",r.toFixed(2)," AED"]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-gray-600",children:[s("cashier.tax")," (",y||0,"%):"]}),e.jsxs("span",{className:"font-medium",children:["+",x.toFixed(2)," AED"]})]}),e.jsx("div",{className:"border-t border-gray-300 pt-2",children:e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsxs("span",{children:[s("cashier.total"),":"]}),e.jsxs("span",{className:"text-primary-700",children:[g.toFixed(2)," AED"]})]})})]})};function se({paymentMode:n,setPaymentMode:m}){const{t:r}=A();return e.jsxs("div",{className:"flex bg-gray-100 rounded-lg p-1 mb-4",children:[e.jsx("button",{type:"button",onClick:()=>m("single"),className:`flex-1 py-2 px-4 text-sm font-medium rounded-md transition-colors ${n==="single"?"bg-white text-gray-900 shadow-sm":"text-gray-600 hover:text-gray-900"}`,children:r("payment.singlePayment")}),e.jsx("button",{type:"button",onClick:()=>m("split"),className:`flex-1 py-2 px-4 text-sm font-medium rounded-md transition-colors ${n==="split"?"bg-white text-gray-900 shadow-sm":"text-gray-600 hover:text-gray-900"}`,children:r("payment.splitPayment")})]})}const te=({payment:n,index:m,onMethodChange:r,onAmountChange:y,finalTotal:x})=>{const g=s=>{y(m,s);const u=m===0?1:0;if(y(u,""),s&&!isNaN(s)){const j=x-parseFloat(s);j>0?y(u,parseFloat(j.toFixed(2))):y(u,0)}};return e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"flex-1",children:e.jsx(T,{value:n.method,onChange:s=>r(m,s.target.value)})}),e.jsx("div",{className:"flex-1",children:e.jsx(M,{value:n.amount,onChange:g,placeholder:"0.00",min:"0",step:"1"})})]})},ae=h.lazy(()=>O(()=>import("./PrintReceiptModal-Bx7Ija2Q.js"),__vite__mapDeps([0,1,2])));function re({tax:n,setTax:m,discount:r,setDiscount:y,subtotal:x,discountAmount:g}){const{t:s}=A(),u=Q(),j=X(),{currentOrder:t}=F(a=>a.order),{loading:v}=F(a=>a.payment),{currentShift:l}=F(a=>a.shift),{user:P}=F(a=>a.auth),[S,L]=h.useState("single"),[E,z]=h.useState("cash"),[_,k]=h.useState([{method:"cash",amount:""},{method:"visa",amount:""}]),[H,D]=h.useState(!1),[J,I]=h.useState(!1),R=x*(n||0)/100,p=x-g+R,K=h.useCallback((a,c)=>{k(o=>{const d=[...o];return d[a].method=c,d})},[]),U=h.useCallback((a,c)=>{k(o=>{const d=[...o];return d[a].amount=c,d})},[]),W=_.reduce((a,c)=>{const o=parseFloat(c.amount)||0;return a+o},0),V=p-W,q=()=>{const a=_.filter(o=>(parseFloat(o.amount)||0)>0);if(a.length===0)return{isValid:!1,message:s("payment.enterPaymentAmount")};const c=a.reduce((o,d)=>o+parseFloat(d.amount),0);if(c<p)return{isValid:!1,message:`${s("payment.needMoreAmount")} ${(p-c).toFixed(2)} AED`};if(c>p){const o=[...a];let d=p;for(let i=0;i<o.length;i++){const b=parseFloat(o[i].amount);if(d>=b)d-=b;else{o[i].amount=d,d=0,o.splice(i+1);break}}return{isValid:!0,payments:o}}return{isValid:!0,payments:a}},B=async()=>{var a,c,o,d;if(!t){f.error(s("payment.noOrderSelected"));return}if(t.isPaid){f.error(s("payment.orderAlreadyPaid"));return}if(J){console.log("Payment already processed for this order");return}I(!0);try{let i=[];if(S==="single")i=[{method:E,amount:p}];else{const w=q();if(!w.isValid){f.error(w.message);return}i=w.payments.map($=>({method:$.method,amount:parseFloat($.amount)}))}if((await u(Y({orderId:t._id,paymentMethods:i,tax:n||0,discount:r||0})).unwrap()).alreadyPaid){f.success(s("payment.alreadyPaidSuccess"),{duration:3e3,icon:"✅"}),l!=null&&l._id?await u(N({shiftId:l._id})):await u(N()),setTimeout(()=>{j("/menu")},1500);return}l!=null&&l._id?await u(N({shiftId:l._id})):await u(N()),f.success(s("payment.paymentSuccess"),{duration:3e3,icon:"✅"}),setTimeout(()=>{j("/menu")},1500);const C={...t,orderNumber:t.orderCode||((a=t._id)==null?void 0:a.slice(-8))||"N/A",cashier:(P==null?void 0:P.name)||"System",paymentMethods:i,tax:n||0,discount:r||0,finalTotal:p,subtotal:p-(n||0)+(r||0),orderItems:t.orderItems||[],orderItemsData:t.orderItemsData||[],custName:t.custName||"",custPhone:t.custPhone||t.custtPhone||"",custAddress:t.custAddress||""};try{await Z.printCustomerReceipt(C),console.log("✅ Customer receipt printed successfully to customer printer")}catch(w){console.warn("❌ Customer receipt print failed:",w)}}catch(i){console.error("Payment failed:",i),I(!1);let b=s("payment.paymentFailedRetry"),C=!1;if(i.shouldRetry?(b=i.message+" Would you like to try again?",C=!0):i.message&&(b=i.message),(c=i.message)!=null&&c.includes("already paid")||(d=(o=i.originalError)==null?void 0:o.message)!=null&&d.includes("already paid")){l!=null&&l._id?await u(N({shiftId:l._id})):await u(N()),f.error(s("payment.paymentStatusUnclear"),{duration:5e3,icon:"⚠️"});return}f.error(b,{duration:C?6e3:4e3,icon:"❌"})}};h.useEffect(()=>{I(!1)},[t==null?void 0:t._id]);const G=()=>{if(!t){f.error(s("payment.noOrderSelected"));return}D(!0)};return e.jsxs("div",{className:"bg-white rounded-lg shadow-card p-2 sm:p-6 space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(M,{label:s("payment.taxPercent"),value:n,onChange:m,placeholder:"0",min:"0",max:"100",step:"1"}),e.jsx(M,{label:s("payment.discountPercent"),value:r,onChange:y,placeholder:"0",min:"0",max:"100",step:"1"})]}),e.jsx(ee,{subtotal:x,discount:r,discountAmount:g,tax:n,taxAmount:R,finalTotal:p}),e.jsxs("div",{children:[e.jsx("label",{className:"hidden sm:block text-sm font-medium text-gray-700 mb-3",children:s("payment.paymentMethod")}),e.jsx(se,{paymentMode:S,setPaymentMode:L}),S==="single"&&e.jsx(T,{value:E,onChange:a=>z(a.target.value)}),S==="split"&&e.jsxs("div",{className:"space-y-3",children:[_.map((a,c)=>e.jsx(te,{payment:a,index:c,onMethodChange:K,onAmountChange:U,finalTotal:p},c)),e.jsxs("div",{className:"text-sm text-gray-600 bg-blue-50 p-2 rounded text-start",children:[s("payment.remaining"),":"," ",e.jsx("span",{className:`font-medium ${V>0?"text-red-600":"text-green-600"}`,children:V.toFixed(2)})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{onClick:B,disabled:v||!t||(t==null?void 0:t.isPaid),className:`w-full py-3 px-4 rounded-md transition-colors font-medium ${t!=null&&t.isPaid?"bg-green-100 text-green-800 cursor-not-allowed":"bg-green-600 text-white hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed"}`,children:t!=null&&t.isPaid?s("payment.orderAlreadyPaid"):v?s("payment.processing"):`${s("payment.pay")} ${p.toFixed(2)} AED`}),e.jsx("button",{onClick:G,className:"w-full py-2 px-4 bg-primary-700 text-white rounded-md hover:bg-primary-800 transition-colors",children:t!=null&&t.isPaid?s("payment.printReceipt"):s("payment.printPreview")})]}),H&&e.jsx(h.Suspense,{fallback:e.jsx("div",{children:s("common.loading")}),children:e.jsx(ae,{order:t,onClose:()=>D(!1)})})]})}export{re as default};
